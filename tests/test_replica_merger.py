#!/usr/bin/env python3
"""
tests/test_replica_merger.py - Unit tests –¥–ª—è replica_merger v16.22

üÜï v16.22: –¢–µ—Å—Ç—ã –¥–ª—è –ë–ê–ì #3 - loop artifacts —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —Å–ª–æ–≤
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'scripts'))

import unittest
from merge.replica_merger import clean_loops


class TestCleanLoops(unittest.TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è clean_loops()"""
    
    def test_remove_exact_loop(self):
        """
        ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç: —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–∞
        
        "–±—ã–ª–æ —ç—Ç–æ –±—ã–ª–æ" ‚Üí "–±—ã–ª–æ"
        """
        text = "–ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ —ç—Ç–æ –±—ã–ª–æ —Å–Ω–æ–≤–∞ –ø–æ–≤—Ç–æ—Ä –±—ã–ª–æ —ç—Ç–æ –±—ã–ª–æ –∫–æ–Ω–µ—Ü"
        result = clean_loops(text, debug=False)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä —É–¥–∞–ª—ë–Ω
        self.assertLess(
            result.count("–±—ã–ª–æ —ç—Ç–æ –±—ã–ª–æ"),
            text.count("–±—ã–ª–æ —ç—Ç–æ –±—ã–ª–æ"),
            "–¢–æ—á–Ω—ã–π –ø–æ–≤—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–∞–ª—ë–Ω!"
        )
    
    def test_remove_loop_with_word_variations(self):
        """
        üêõ –ë–ê–ì #3: Loop —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ —Å–ª–æ–≤ –ù–ï –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è
        
        –°—Ü–µ–Ω–∞—Ä–∏–π:
        "—É—á–∏—Ç—ã–≤–∞—Ç—å –±—ã–ª–∞ –Ω–µ–º–µ—Ü–∫–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è –≤–ø—Ä–∞–≤—å –¥–æ –µ—â–µ –æ–¥–Ω–∏–º —Ñ–∞–∫—Ç–æ—Ä–æ–º 
         –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —ç—Ç–æ –±—ã–ª–æ –Ω–µ–º–µ—Ü–∫–∞—è –≤–ø–ª–æ—Ç—å –¥–æ. 
         –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —ç—Ç–æ –±—ã–ª–∞ –Ω–µ–º–µ—Ü–∫–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è, –≤–ø–ª–æ—Ç—å –¥–æ"
        
        ‚Üí 3 –≤–∞—Ä–∏–∞—Ü–∏–∏ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑—ã!
        
        –û–ñ–ò–î–ê–ï–¢–°–Ø:
        –¢–æ–ª—å–∫–æ –û–î–ù–ê –≤–∞—Ä–∏–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è (—Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è/–ø–æ–ª–Ω–∞—è)
        
        –†–ï–ê–õ–¨–ù–û–°–¢–¨ (–±–∞–≥):
        –í—Å–µ 3 –≤–∞—Ä–∏–∞—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è (clean_loops –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã)
        """
        text = (
            "—É—á–∏—Ç—ã–≤–∞—Ç—å –±—ã–ª–∞ –Ω–µ–º–µ—Ü–∫–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è –≤–ø—Ä–∞–≤—å –¥–æ –µ—â–µ –æ–¥–Ω–∏–º —Ñ–∞–∫—Ç–æ—Ä–æ–º "
            "–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —ç—Ç–æ –±—ã–ª–æ –Ω–µ–º–µ—Ü–∫–∞—è –≤–ø–ª–æ—Ç—å –¥–æ. "
            "–∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —ç—Ç–æ –±—ã–ª–∞ –Ω–µ–º–µ—Ü–∫–∞—è –∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è, –≤–ø–ª–æ—Ç—å –¥–æ"
        )
        
        result = clean_loops(text, debug=False)
        
        # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–π "—É—á–∏—Ç—ã–≤–∞—Ç—å"
        count_uchit = result.count("—É—á–∏—Ç—ã–≤–∞—Ç—å")
        
        # –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –º–∞–∫—Å–∏–º—É–º 1 –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–µ 3!)
        self.assertLessEqual(
            count_uchit,
            1,
            f"Loop —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –ù–ï —É–¥–∞–ª—ë–Ω! –ù–∞–π–¥–µ–Ω–æ '—É—á–∏—Ç—ã–≤–∞—Ç—å': {count_uchit} —Ä–∞–∑\n–¢–µ–∫—Å—Ç: {result}"
        )
        
        # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–π "–Ω–µ–º–µ—Ü–∫–∞—è"
        count_nem = result.count("–Ω–µ–º–µ—Ü–∫–∞—è")
        
        # –î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –º–∞–∫—Å–∏–º—É–º 1 –≤–∞—Ä–∏–∞–Ω—Ç
        self.assertLessEqual(
            count_nem,
            1,
            f"Loop —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –ù–ï —É–¥–∞–ª—ë–Ω! –ù–∞–π–¥–µ–Ω–æ '–Ω–µ–º–µ—Ü–∫–∞—è': {count_nem} —Ä–∞–∑\n–¢–µ–∫—Å—Ç: {result}"
        )
    
    def test_preserve_different_phrases(self):
        """
        ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç: –ù–ï —É–¥–∞–ª—è—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        
        "—ç—Ç–æ –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ" –∏ "—ç—Ç–æ –±—ã–ª–æ –ø–ª–æ—Ö–æ" - —Ä–∞–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã!
        """
        text = "–ü–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —ç—Ç–æ –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –Ω–∞—Å. –í—Ç–æ—Ä–æ–µ —Å–æ–±—ã—Ç–∏–µ —ç—Ç–æ –±—ã–ª–æ –ø–ª–æ—Ö–æ –¥–ª—è –Ω–∏—Ö."
        result = clean_loops(text, debug=False)
        
        # –û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è
        self.assertIn("—Ö–æ—Ä–æ—à–æ", result)
        self.assertIn("–ø–ª–æ—Ö–æ", result)
    
    def test_short_text_no_loops(self):
        """
        ‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç: –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
        """
        text = "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤"
        result = clean_loops(text, debug=False)
        
        # –¢–µ–∫—Å—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
        self.assertEqual(result, text)


if __name__ == '__main__':
    unittest.main()
