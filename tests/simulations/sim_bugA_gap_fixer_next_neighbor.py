"""
tests/simulations/sim_bugA_gap_fixer_next_neighbor.py

–ë–ê–ì A: gap_fixer_v2 –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –°–õ–ï–î–£–Æ–©–ï–ì–û —è–∫–æ—Ä—è.

–¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ [00:27:16] –ò—Å–∞–µ–≤:
  - –û—Å–Ω–æ–≤–Ω–æ–π inject: 00:28:09 (word#73/179, gap=46.6s)
  - gap_fixer_v2 –Ω–∞—Ö–æ–¥–∏—Ç GAP: 00:27:16 ‚Üí 00:28:09 = 53s
  - –í—Å—Ç–∞–≤–ª—è–µ—Ç inject=00:27:51 (gap_from=36s)
  - –ò—Ç–æ–≥: 00:27:51 ‚Üí 00:28:09 = 18s ‚ùå

ROOT CAUSE: gap_fixer_v2 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ (est_t - last_t >= interval),
–Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç (gap_end_sec - real_t >= min_gap_to_next).

EXPECTED (BUG):  inject 00:27:51, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ 00:28:09 = 18s < 25s ‚ùå
EXPECTED (FIX):  inject –ø—Ä–æ–ø—É—â–µ–Ω (SKIP next-neighbor), –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ 00:28:09
"""

import re
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent / "scripts"))

from corrections.timestamp_fixer import gap_fixer_v2
from core.utils import seconds_to_hms

# ‚îÄ‚îÄ –¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ [00:27:16] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SEG_START = 27 * 60 + 16        # 1636s
SEG_END   = 29 * 60 + 10        # 1750s

# –û—Å–Ω–æ–≤–Ω–æ–π inject —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω (word#73/179, gap=46.6s –æ—Ç —Å—Ç–∞—Ä—Ç–∞)
PLANNED_INJECT_STR = "00:28:09"
PLANNED_INJECT_SEC = 28 * 60 + 9   # 1689s

# –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ –ü–û–°–õ–ï –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞ (—Å —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º 00:28:09).
# –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º 8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–∑ –ª–æ–≥–∞ + inject –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ.
# –ü–µ—Ä–≤—ã–µ ~73 —Å–ª–æ–≤–∞ –∏–∑ 179 –∏–¥—É—Ç –¥–æ 00:28:09, –∑–∞—Ç–µ–º inject, –∑–∞—Ç–µ–º –æ—Å—Ç–∞—Ç–æ–∫.
seg_text = (
    "—Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –±—É–¥—É—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∞—Ç–∞–∫–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–ø–µ—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å. "
    "–í —Ç—ã–ª—É –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞ –±—ã–ª –≤—ã–±—Ä–∞–Ω —É—á–∞—Å—Ç–æ–∫ –ù–µ–≤—ã –∏ –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–∑–µ—Ä. "
    "–ò –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–≤–µ–ª–∏ –∫ —Ç–æ–º—É —á—Ç–æ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∏—é "
    "–±—ã–ª–∏ –æ—Ç—Ç–æ—á–µ–Ω—ã –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–º–∞. "
    "–¢–æ—á–Ω–æ —Ç–∞–∫ –∂–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∏–º–µ—Ä —Å –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≤–æ–ª–æ—á–Ω—ã—Ö "
    f"–∑–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–π –∏ –ø—Ä–æ—á–∏–º {PLANNED_INJECT_STR} "
    "–ò –æ–ø—è—Ç—å –∂–µ –Ω–∞ –æ–∑–µ—Ä–∞—Ö —Ç—â–∞—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å —Ç–∞–∫–∞—è –≤–µ—â—å –∫–∞–∫ —à—Ç—É—Ä–º "
    "–≤—ã—Å–æ–∫–æ–≥–æ –±–µ—Ä–µ–≥–∞. "
    "–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –ª–µ—Å—Ç–Ω–∏—Ü—ã –≤ –æ–¥–Ω–æ–π –∏–∑ –¥–∏–≤–∏–∑–∏–π –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ "
    "—à—Ç—É—Ä–º–æ–≤–∞—Ç—å –±–µ—Ä–µ–≥ –∑–∞–Ω—è—Ç—ã–π –Ω–µ–º—Ü–∞–º–∏. "
    "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –µ—â–µ –∫–æ—à–∫–∏ –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∫–∞—Ä–∞–±–∫–∞—Ç—å—Å—è –≤–≤–µ—Ä—Ö. "
    "–≠—Ç–æ –≤—Å–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –±—ã–ª–æ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –º–µ—Ä–æ–π –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–ª–∞—Å—å."
)

# sub_segments ‚Äî —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞: 128 —à—Ç, 1-2 —Å–ª–æ–≤–∞ –∫–∞–∂–¥—ã–π
# –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞–Ω–æ–º–∞–ª—å–Ω–æ –º–µ–ª–∫—É—é –Ω–∞—Ä–µ–∑–∫—É –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
words_clean = [t for t in seg_text.split()
               if not re.match(r'^\d{2}:\d{2}:\d{2}$', t)]
n_words = len(words_clean)
duration = SEG_END - SEG_START   # 114s

# 128 sub_segments –Ω–∞ ~179 —Å–ª–æ–≤ ‚Äî 1 —Å–ª–æ–≤–æ –Ω–∞ sub
sub_segments = []
step = duration / max(n_words, 1)
for i in range(n_words):
    t = SEG_START + i * step
    sub_segments.append({"start": t, "end": t + step, "words": 1})
total_pre = n_words

# ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
print("=" * 60)
print("–ë–ê–ì A: gap_fixer_v2 ‚Äî next-neighbor collision")
print("=" * 60)
print(f"Segment:          {seconds_to_hms(SEG_START)}‚Äì{seconds_to_hms(SEG_END)} ({duration}s)")
print(f"–ü–ª–∞–Ω–æ–≤—ã–π inject:  {PLANNED_INJECT_STR} (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ö–æ–¥)")
print(f"–û–∂–∏–¥–∞–µ–º—ã–π GAP:    {seconds_to_hms(SEG_START)} ‚Üí {PLANNED_INJECT_STR} = "
      f"{PLANNED_INJECT_SEC - SEG_START}s")
print()

new_text, log = gap_fixer_v2(
    seg_text, SEG_START, SEG_END,
    sub_segments, total_pre,
    interval=30.0, threshold=45.0,
    lookahead=12, debug=True
)

# ‚îÄ‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
print()
print("‚îÄ‚îÄ –†–ï–ó–£–õ–¨–¢–ê–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
all_ts = re.findall(r'\b(\d{2}:\d{2}:\d{2})\b', new_text)
print(f"–í—Å–µ inject –≤ —Ç–µ–∫—Å—Ç–µ: {all_ts}")

ts_secs = sorted(
    int(t.split(':')[0]) * 3600 + int(t.split(':')[1]) * 60 + int(t.split(':')[2])
    for t in all_ts
)

print()
print("‚îÄ‚îÄ –í–ê–õ–ò–î–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
MIN_GAP = 25
all_ok = True
for i in range(1, len(ts_secs)):
    gap = ts_secs[i] - ts_secs[i - 1]
    status = "‚úÖ" if gap >= MIN_GAP else "‚ùå –ë–ê–ì"
    print(f"  {seconds_to_hms(ts_secs[i-1])} ‚Üí {seconds_to_hms(ts_secs[i])} = {gap}s {status}")
    if gap < MIN_GAP:
        all_ok = False

if log:
    injected_t = log[0]["real_t"]
    dist_to_next = PLANNED_INJECT_SEC - injected_t
    print()
    print(f"  gap_fixer inject:         {seconds_to_hms(injected_t)}")
    print(f"  –ü–ª–∞–Ω–æ–≤—ã–π inject:          {PLANNED_INJECT_STR}")
    print(f"  –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏:    {dist_to_next:.0f}s")
    if dist_to_next < MIN_GAP:
        print(f"  ‚ùå –ë–ê–ì –í–û–°–ü–†–û–ò–ó–í–ï–î–Å–ù: {dist_to_next:.0f}s < {MIN_GAP}s")
    else:
        print(f"  ‚úÖ OK: {dist_to_next:.0f}s ‚â• {MIN_GAP}s")
else:
    print()
    print(f"  gap_fixer inject: –Ω–µ—Ç (–ø—Ä–æ–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)")
    print(f"  ‚úÖ –§–ò–ö–° –†–ê–ë–û–¢–ê–ï–¢: next-neighbor guard –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –≤—Å—Ç–∞–≤–∫—É")

print()
if not all_ok:
    print("üî¥ –†–ï–ó–£–õ–¨–¢–ê–¢: –ë–ê–ì –í–û–°–ü–†–û–ò–ó–í–ï–î–Å–ù (RED)")
else:
    print("üü¢ –†–ï–ó–£–õ–¨–¢–ê–¢: GREEN ‚Äî —Ñ–∏–∫—Å –ø—Ä–∏–º–µ–Ω—ë–Ω")
