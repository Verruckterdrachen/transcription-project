"""
sim_bug15r — РЕГРЕССИЯ БАГ #15: clean_loops удаляет фразу оставляя висячий предлог
ROOT CAUSE: нет guard при РИСК ОБРУБКА
"""
import sys, os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../scripts'))
from merge.replica_merger import clean_loops  # адаптировать к реальному import

TESTS = [
    # (входной текст, ожидаемый результат)
    (
        # БАГ #15: gap-fill дублирует хвост
        "...Ленинградского фронта на прорыв блокады изнутри. "
        "Невский пятачок, хотя располагался в достаточно удобном месте "
        "прорыва блокада изнутри.",
        # ожидаем: правильная форма СОХРАНЕНА, косноязычная УДАЛЕНА
        "прорыв блокады изнутри."
    ),
    (
        # MERGE #6: 'очень удобном' vs 'достаточно удобном'
        "...располагался в очень удобном месте для обороны. "
        "...располагался в достаточно удобном месте для обороны.",
        # ожидаем: одна версия, предлог 'в' не висит
        "в "  # фраза должна начинаться с 'в', не заканчиваться
    ),
    (
        # MERGE #8: 'с' не должен висеть
        "...все наступление с Невского пятачка терпит поражение. "
        "...все наступление с невского пятачка. В итоге...",
        "с Невского пятачка"
    ),
    (
        # Безопасный случай (нет предлога) — удаление разрешено
        "В октябре немцы перешли в наступление. "
        "В октябре немцы перешли в наступление.",
        "В октябре немцы перешли в наступление."  # одна копия
    ),
]

passed = 0
for i, (text_in, expected_fragment) in enumerate(TESTS):
    result = clean_loops(text_in)
    ok = expected_fragment in result
    status = "✅ GREEN" if ok else "❌ RED"
    print(f"{status} Test {i+1}")
    if not ok:
        print(f"  Ожидали фрагмент: '{expected_fragment}'")
        print(f"  Получили: '{result[:120]}'")
    else:
        passed += 1

print(f"\n{passed}/{len(TESTS)} GREEN")
sys.exit(0 if passed == len(TESTS) else 1)
