"""
tests/simulations/sim_bugB_gap_fixer_prev_neighbor.py

–ë–ê–ì B: gap_fixer_v2 –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ü–†–ï–î–´–î–£–©–ï–ì–û —è–∫–æ—Ä—è.

–¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ [00:16:12] –ò—Å–∞–µ–≤:
  - –û—Å–Ω–æ–≤–Ω–æ–π inject: [FALLBACK] 00:17:05 (word#80/272, gap=47.4s)
  - gap_fixer_v2 –Ω–∞—Ö–æ–¥–∏—Ç GAP: 00:16:12 ‚Üí 00:17:05 = 53s
  - –í—Å—Ç–∞–≤–ª—è–µ—Ç inject=00:16:45 (gap_from=33s ‚úÖ ‚Äî —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞–∑–∞–¥)
  - –ò—Ç–æ–≥: 00:16:45 ‚Üí 00:17:05 = 20s ‚ùå (—Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É!)

–ó–ê–ú–ï–ß–ê–ù–ò–ï: –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Ç–æ —Ç–æ—Ç –∂–µ –±–∞–≥ —á—Ç–æ A, –Ω–æ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π:
  gap_fixer –≤–∏–¥–∏—Ç gap [16:12 ‚Üí 17:05], –≤—Å—Ç–∞–≤–ª—è–µ—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω—É 16:45,
  –Ω–µ –∑–∞–º–µ—á–∞—è —á—Ç–æ 17:05 —É–∂–µ –µ—Å—Ç—å –∏ —Å—Ç–æ–∏—Ç —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ.
  –û–±–∞ –±–∞–≥–∞ ‚Äî –æ–¥–∏–Ω root cause: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ next-anchor proximity.

ROOT CAUSE: —Ç–µ –∂–µ —á—Ç–æ –≤ –ë–∞–≥–µ A ‚Äî
  gap_fixer_v2: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (gap_end_sec - real_t) < min_gap_to_next

EXPECTED (BUG):  inject 00:16:45, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ 00:17:05 = 20s < 25s ‚ùå
EXPECTED (FIX):  inject –ø—Ä–æ–ø—É—â–µ–Ω (SKIP next-neighbor), –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ 00:17:05
"""

import re
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent.parent / "scripts"))

from corrections.timestamp_fixer import gap_fixer_v2
from core.utils import seconds_to_hms

# ‚îÄ‚îÄ –¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ [00:16:12] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SEG_START = 16 * 60 + 12        # 972s
SEG_END   = 18 * 60 + 53        # 1133s  (–¥–ª–∏—Ç=161.2s)

# –û—Å–Ω–æ–≤–Ω–æ–π FALLBACK inject: 00:17:05 (word#80/272, gap=47.4s)
PLANNED_INJECT_STR = "00:17:05"
PLANNED_INJECT_SEC = 17 * 60 + 5    # 1025s

# –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ –ü–û–°–õ–ï –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞.
# 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–∑ –ª–æ–≥–∞: –ø–µ—Ä–≤—ã–µ ~80 —Å–ª–æ–≤ –¥–æ 00:17:05, –∑–∞—Ç–µ–º inject, –æ—Å—Ç–∞—Ç–æ–∫.
# –ò–∑ –ª–æ–≥–∞ ‚Äî 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, 272 —Å–ª–æ–≤–∞ —Å—É–º–º–∞—Ä–Ω–æ.
seg_text = (
    "–í –Ω–∞—á–∞–ª–µ –¥–µ–∫–∞–±—Ä—è —Å–æ—Ä–æ–∫ –≤—Ç–æ—Ä–æ–≥–æ –≥–æ–¥–∞ –ø–ª–∞–Ω –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω "
    "–°—Ç–∞–≤–∫–µ –í–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –ì–ª–∞–≤–Ω–æ–∫–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–ª –Ω–∞–Ω–µ—Å–µ–Ω–∏–µ —É–¥–∞—Ä–∞ –Ω–µ "
    "—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Ä—ã–≤–∞ –±–ª–æ–∫–∞–¥—ã –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥–∞ –Ω–æ –∏ –¥–ª—è –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏—Ö –∑–∞–¥–∞—á. "
    "–í—ã–∑–≤–∞–Ω–æ —ç—Ç–æ –±—ã–ª–æ —è–≤–Ω–æ —É—Å–ø–µ—Ö–∞–º–∏ –ø–æ–¥ –°—Ç–∞–ª–∏–Ω–≥—Ä–∞–¥–æ–º –∫–æ–≥–¥–∞ —Å–æ–≤–µ—Ç—Å–∫–∏–µ –≤–æ–π—Å–∫–∞ "
    "–æ–∫—Ä—É–∂–∏–ª–∏ –∫—Ä—É–ø–Ω—É—é –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –Ω–µ–º—Ü–µ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ä–∏—Ç—å —É—Å–ø–µ—Ö "
    "–∏ –Ω–∞ —Å–µ–≤–µ—Ä–Ω–æ–º —É—á–∞—Å—Ç–∫–µ —Å–æ–≤–µ—Ç—Å–∫–æ-–≥–µ—Ä–º–∞–Ω—Å–∫–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞. "
    f"{PLANNED_INJECT_STR} "
    "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –°—Ç–∞–ª–∏–Ω –≤–Ω–µ—Å –∫–æ—Ä—Ä–µ–∫—Ç–∏–≤—ã –≤ –ø–ª–∞–Ω —Ç–æ –µ—Å—Ç—å –±—ã–ª–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ "
    "–∑–∞–¥–∞—á–∞ –ø–æ—Å–ª–µ –ø—Ä–æ—Ä—ã–≤–∞ –±–ª–æ–∫–∞–¥—ã —Ä–∞–∑–≤–∏—Ç—å –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥–ª—É–±–∏–Ω—É —Å —Ç–µ–º —á—Ç–æ–±—ã "
    "–æ—Ç–±—Ä–æ—Å–∏—Ç—å –Ω–µ–º—Ü–µ–≤ –æ—Ç –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥–∞ –Ω–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ —Ç–µ–º —Å–∞–º—ã–º "
    "–æ–±–µ—Å–ø–µ—á–∏—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é —Å—É—Ö–æ–ø—É—Ç–Ω—É—é —Å–≤—è–∑—å –≥–æ—Ä–æ–¥–∞ —Å –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–æ–π."
)

# sub_segments ‚Äî –∏–∑ –ª–æ–≥–∞: 43 —à—Ç, 272 —Å–ª–æ–≤–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –Ω–∞—Ä–µ–∑–∫–∞ ~6 —Å–ª–æ–≤ –Ω–∞ sub)
words_clean = [t for t in seg_text.split()
               if not re.match(r'^\d{2}:\d{2}:\d{2}$', t)]
n_words = len(words_clean)
duration = SEG_END - SEG_START   # 161s

# 43 sub_segments ‚Äî –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∏–∑ –ª–æ–≥–∞ —Ç–æ—á–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ãÃÅ–µ –≥—Ä–∞–Ω–∏—Ü—ã
# (—É–ø—Ä–æ—â—ë–Ω–Ω–æ: —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ç–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª–∏–Ω–Ω—ã–π)
sub_segments = []
words_per_sub = n_words / 43
for i in range(43):
    t_start = SEG_START + (i / 43) * duration
    t_end   = SEG_START + ((i + 1) / 43) * duration
    sub_segments.append({
        "start": t_start,
        "end":   t_end,
        "words": max(1, round(words_per_sub))
    })
total_pre = sum(s["words"] for s in sub_segments)

# ‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
print("=" * 60)
print("–ë–ê–ì B: gap_fixer_v2 ‚Äî prev-neighbor collision (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π)")
print("=" * 60)
print(f"Segment:          {seconds_to_hms(SEG_START)}‚Äì{seconds_to_hms(SEG_END)} ({duration:.0f}s)")
print(f"–ü–ª–∞–Ω–æ–≤—ã–π inject:  {PLANNED_INJECT_STR} (FALLBACK –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞)")
print(f"–û–∂–∏–¥–∞–µ–º—ã–π GAP:    {seconds_to_hms(SEG_START)} ‚Üí {PLANNED_INJECT_STR} = "
      f"{PLANNED_INJECT_SEC - SEG_START}s")
print()

new_text, log = gap_fixer_v2(
    seg_text, SEG_START, SEG_END,
    sub_segments, total_pre,
    interval=30.0, threshold=45.0,
    lookahead=12, debug=True
)

# ‚îÄ‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
print()
print("‚îÄ‚îÄ –†–ï–ó–£–õ–¨–¢–ê–¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
all_ts = re.findall(r'\b(\d{2}:\d{2}:\d{2})\b', new_text)
print(f"–í—Å–µ inject –≤ —Ç–µ–∫—Å—Ç–µ: {all_ts}")

ts_secs = sorted(
    int(t.split(':')[0]) * 3600 + int(t.split(':')[1]) * 60 + int(t.split(':')[2])
    for t in all_ts
)

print()
print("‚îÄ‚îÄ –í–ê–õ–ò–î–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
MIN_GAP = 25
all_ok = True
for i in range(1, len(ts_secs)):
    gap = ts_secs[i] - ts_secs[i - 1]
    status = "‚úÖ" if gap >= MIN_GAP else "‚ùå –ë–ê–ì"
    print(f"  {seconds_to_hms(ts_secs[i-1])} ‚Üí {seconds_to_hms(ts_secs[i])} = {gap}s {status}")
    if gap < MIN_GAP:
        all_ok = False

if log:
    injected_t = log[0]["real_t"]
    dist_to_next = PLANNED_INJECT_SEC - injected_t
    print()
    print(f"  gap_fixer inject:         {seconds_to_hms(injected_t)}")
    print(f"  –ü–ª–∞–Ω–æ–≤—ã–π inject:          {PLANNED_INJECT_STR}")
    print(f"  –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏:    {dist_to_next:.0f}s")
    if dist_to_next < MIN_GAP:
        print(f"  ‚ùå –ë–ê–ì –í–û–°–ü–†–û–ò–ó–í–ï–î–Å–ù: {dist_to_next:.0f}s < {MIN_GAP}s")
    else:
        print(f"  ‚úÖ OK: {dist_to_next:.0f}s ‚â• {MIN_GAP}s")
else:
    print()
    print(f"  gap_fixer inject: –Ω–µ—Ç (–ø—Ä–æ–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)")
    print(f"  ‚úÖ –§–ò–ö–° –†–ê–ë–û–¢–ê–ï–¢: next-neighbor guard –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª –≤—Å—Ç–∞–≤–∫—É")

print()
if not all_ok:
    print("üî¥ –†–ï–ó–£–õ–¨–¢–ê–¢: –ë–ê–ì –í–û–°–ü–†–û–ò–ó–í–ï–î–Å–ù (RED)")
else:
    print("üü¢ –†–ï–ó–£–õ–¨–¢–ê–¢: GREEN ‚Äî —Ñ–∏–∫—Å –ø—Ä–∏–º–µ–Ω—ë–Ω")
