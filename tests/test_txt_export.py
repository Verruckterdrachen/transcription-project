#!/usr/bin/env python3
"""
tests/test_txt_export.py - Unit tests –¥–ª—è –ë–ê–ì #1 + –ë–ê–ì #2

üîß v16.23.2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ª–æ–≤–∏—è —Ç–µ—Å—Ç–æ–≤ - checkpoint —á–µ—Ä–µ–∑ 30s
üîß v16.23.1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã - –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è inner timestamps
üÜï v16.23: –¢–µ—Å—Ç–∏—Ä—É–µ–º insert_inner_timestamps() - –Ω–µ—Ç –¥—É–±–ª–µ–π, –Ω–µ—Ç "–Ω–∞–∑–∞–¥"
"""

import pytest
from scripts.export.txt_export import insert_inner_timestamps


def test_no_duplicate_timestamps():
    """
    üêõ –ë–ê–ì #1: –î—É–±–ª–∏ timestamp
    
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ inner timestamp –ù–ï —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª—å –µ—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —Å–µ–≥–º–µ–Ω—Ç
    –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–æ–≥–æ –∂–µ –≤—Ä–µ–º–µ–Ω–∏.
    """
    # üîß v16.23.2: 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, duration 70s ‚Üí checkpoint —á–µ—Ä–µ–∑ ~30s
    long_sentence = (
        "–≠—Ç–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è inner timestamps, "
        "–∫–æ—Ç–æ—Ä–æ–µ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã, "
        "–∞ —Ç–∞–∫–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ —á—Ç–æ–±—ã —Ä–∞—Å—Ç—è–Ω—É—Ç—å –µ–≥–æ –µ—â—ë –±–æ–ª—å—à–µ. "
    )
    text = (long_sentence + ". ") * 5  # 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å —Ç–æ—á–∫–∞–º–∏
    
    start_sec = 100.0
    end_sec = 170.0  # 70 —Å–µ–∫—É–Ω–¥ (–∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ~14s)
    next_segment_exists = True
    
    result = insert_inner_timestamps(text, start_sec, end_sec, next_segment_exists)
    
    # Inner timestamp –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å \n)
    assert "\n" in result, f"Inner timestamp –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ \\n. –†–µ–∑—É–ª—å—Ç–∞—Ç: {result[:300]}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ù–ï–¢ –¥–≤—É—Ö timestamp –ø–æ–¥—Ä—è–¥ –±–µ–∑ \n –º–µ–∂–¥—É –Ω–∏–º–∏
    lines = result.split('\n')
    
    for line in lines:
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º timestamp –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        timestamps = [word for word in line.split() if word.count(':') == 2 and len(word) == 8]
        # –í –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ú–ê–ö–°–ò–ú–£–ú 1 timestamp
        assert len(timestamps) <= 1, f"–ë–ê–ì #1: –ù–∞–π–¥–µ–Ω–æ {len(timestamps)} timestamp –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ: {line[:100]}"


def test_timestamps_monotonic():
    """
    üêõ –ë–ê–ì #2: Timestamp –∏–¥—ë—Ç –Ω–∞–∑–∞–¥
    
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ timestamp –∏–¥—É—Ç —Å—Ç—Ä–æ–≥–æ –í–ü–ï–†–Å–î (–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å).
    """
    long_sentence = (
        "–≠—Ç–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è inner timestamps, "
        "–∫–æ—Ç–æ—Ä–æ–µ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã, "
        "–∞ —Ç–∞–∫–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ —á—Ç–æ–±—ã —Ä–∞—Å—Ç—è–Ω—É—Ç—å –µ–≥–æ –µ—â—ë –±–æ–ª—å—à–µ. "
    )
    text = (long_sentence + ". ") * 5
    
    start_sec = 100.0
    end_sec = 170.0
    next_segment_exists = True
    
    result = insert_inner_timestamps(text, start_sec, end_sec, next_segment_exists)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ timestamp –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    import re
    timestamps = re.findall(r'(\d{2}:\d{2}:\d{2})', result)
    
    if len(timestamps) < 2:
        # –ï—Å–ª–∏ –Ω–µ—Ç inner timestamps, —Ç–µ—Å—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–æ —ç—Ç–æ –Ω–µ –Ω–æ—Ä–º–∞ –¥–ª—è 70s —Ä–µ–ø–ª–∏–∫–∏)
        pytest.skip("–ù–µ—Ç inner timestamps –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç–∏")
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
    def hms_to_seconds(hms_str):
        h, m, s = map(int, hms_str.split(':'))
        return h * 3600 + m * 60 + s
    
    timestamps_sec = [hms_to_seconds(ts) for ts in timestamps]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å
    for i in range(1, len(timestamps_sec)):
        prev_ts = timestamps_sec[i-1]
        curr_ts = timestamps_sec[i]
        assert curr_ts >= prev_ts, f"–ë–ê–ì #2: Timestamp –∏–¥—ë—Ç –Ω–∞–∑–∞–¥: {timestamps[i-1]} ‚Üí {timestamps[i]}"


def test_inner_timestamp_on_new_line():
    """
    üîß v16.23: Inner timestamp –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
    
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ inner timestamp –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å \n
    """
    long_sentence = (
        "–≠—Ç–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è inner timestamps, "
        "–∫–æ—Ç–æ—Ä–æ–µ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã, "
        "–∞ —Ç–∞–∫–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ —á—Ç–æ–±—ã —Ä–∞—Å—Ç—è–Ω—É—Ç—å –µ–≥–æ –µ—â—ë –±–æ–ª—å—à–µ. "
    )
    text = (long_sentence + ". ") * 5
    
    start_sec = 100.0
    end_sec = 170.0
    next_segment_exists = True
    
    result = insert_inner_timestamps(text, start_sec, end_sec, next_segment_exists)
    
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ inner timestamps (—Ç–µ, —á—Ç–æ —Å \n –ø–µ—Ä–µ–¥ –Ω–∏–º–∏)
    import re
    inner_timestamps = re.findall(r'\n(\d{2}:\d{2}:\d{2})', result)
    
    # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω inner timestamp (—Ä–µ–ø–ª–∏–∫–∞ >30s)
    assert len(inner_timestamps) > 0, f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ inner timestamp –¥–ª—è –¥–ª–∏–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏ (70s)! –†–µ–∑—É–ª—å—Ç–∞—Ç: {result[:300]}"


def test_short_text_no_inner_timestamps():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏ (<30s) –ù–ï –ø–æ–ª—É—á–∞—é—Ç inner timestamps
    """
    text = "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç."
    start_sec = 100.0
    end_sec = 105.0  # 5 —Å–µ–∫—É–Ω–¥
    next_segment_exists = True
    
    result = insert_inner_timestamps(text, start_sec, end_sec, next_segment_exists)
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É
    assert result == text, "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å inner timestamps"

def test_no_duplicate_timestamp_at_segment_start():
    """
    üêõ –ë–ê–ì v16.23: –î—É–±–ª—å timestamp –≤ –Ω–∞—á–∞–ª–µ —Å–µ–≥–º–µ–Ω—Ç–∞
    
    **–ü–†–û–ë–õ–ï–ú–ê:**
    –ï—Å–ª–∏ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω–æ–µ (~30s), inner timestamp –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
    –≤ –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ ‚Üí –¥—É–±–ª—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º timestamp.
    
    –ü—Ä–∏–º–µ—Ä –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:
    00:00:56 00:00:56 –¢–æ –µ—Å—Ç—å —ç—Ç–æ –±—ã–ª–æ...
    
    **FIX v16.24:**
    –ü—Ä–æ–≤–µ—Ä–∫–∞: sent_start - start_sec >= 2.0
    Inner timestamp –ù–ï –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –Ω–∞—á–∞–ª—É.
    """
    # –°–æ–∑–¥–∞—ë–º –æ–¥–Ω–æ –û–ß–ï–ù–¨ –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (~35 —Å–µ–∫—É–Ω–¥)
    # —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π checkpoint –æ–∫–∞–∑–∞–ª—Å—è –±–ª–∏–∑–∫–æ –∫ –Ω–∞—á–∞–ª—É
    very_long_sentence = (
        "–≠—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–æ "
        "–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è edge case –∫–æ–≥–¥–∞ –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç–æ–ª—å–∫–æ "
        "–¥–ª–∏–Ω–Ω–æ–µ —á—Ç–æ —É—Å–ª–æ–≤–∏–µ time_since_last >= 25 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É–∂–µ "
        "–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ checkpoint –∏ inner timestamp –ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å—Å—è "
        "–ø—Ä—è–º–æ –≤ –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é "
        "–æ—Å–Ω–æ–≤–Ω–æ–≥–æ timestamp –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ä–µ–ø–ª–∏–∫–∏ –∏ –Ω–∞–º –Ω—É–∂–Ω–æ —ç—Ç–æ "
        "–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –¥–æ–±–∞–≤–∏–≤ –ø—Ä–æ–≤–µ—Ä–∫—É –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è."
    )
    
    text = very_long_sentence + ". –í—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–µ–Ω—å–∫–æ–µ."
    
    start_sec = 100.0  # –û—Å–Ω–æ–≤–Ω–æ–π timestamp
    end_sec = 145.0    # 45 —Å–µ–∫—É–Ω–¥
    next_segment_exists = True
    
    result = insert_inner_timestamps(text, start_sec, end_sec, next_segment_exists)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ timestamp –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    import re
    timestamps = re.findall(r'(\d{2}:\d{2}:\d{2})', result)
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–µ–∫—É–Ω–¥—ã
    def hms_to_seconds(hms_str):
        h, m, s = map(int, hms_str.split(':'))
        return h * 3600 + m * 60 + s
    
    if len(timestamps) > 1:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π inner timestamp (–µ—Å–ª–∏ –µ—Å—Ç—å)
        first_inner_ts = timestamps[0]  # –ú–æ–∂–µ—Ç –±—ã—Ç—å inner, –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω
        first_inner_sec = hms_to_seconds(first_inner_ts)
        
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 2 —Å–µ–∫—É–Ω–¥—ã
        distance_from_start = first_inner_sec - start_sec
        
        assert distance_from_start >= 2.0, (
            f"–ë–ê–ì: Inner timestamp —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –Ω–∞—á–∞–ª—É —Å–µ–≥–º–µ–Ω—Ç–∞! "
            f"start_sec={start_sec}, first_inner={first_inner_sec}, "
            f"distance={distance_from_start:.1f}s (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >=2s)"
        )

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
