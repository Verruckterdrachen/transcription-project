#!/usr/bin/env python3
"""
corrections/speaker_classifier.py - –í–µ—Å–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤ v15 –¥–ª—è v16.8

üÜï v16.8: LONG MONOLOGUE PROTECTION
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∞—Ç—Ä–∏–±—É—Ü–∏–∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –¥–ª–∏–Ω–Ω—ã—Ö –º–æ–Ω–æ–ª–æ–≥–æ–≤ (>60s)
- –ó–∞—â–∏—Ç–∞ –æ—Ç "–¢–æ –µ—Å—Ç—å", "–í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏" –∫–∞–∫ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç—Å–∫–∏—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
- –£—á—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
"""

# Version: v16.8
# Last updated: 2026-02-11
# üÜï v16.8: Long monologue protection –¥–ª—è —Ç–æ—á–Ω–æ–π –∞—Ç—Ä–∏–±—É—Ü–∏–∏

import re
from core.config import SPEAKER_CLASSIFICATION_CONFIDENCE_THRESHOLD, SPEAKER_CLASSIFICATION_MIN_WORDS

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def is_journalist_addressing_speaker(text, word_count):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç–∞ –∫ –°–ø–∏–∫–µ—Ä—É

    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        word_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ

    Returns:
        bool: True –µ—Å–ª–∏ —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç–∞
    """
    text_lower = text.lower()

    journalist_addressing_patterns = [
        r'\b(?:—Ö–æ—Ä–æ—à–æ|–æ—Ç–ª–∏—á–Ω–æ|–ø–æ–Ω—è—Ç–Ω–æ|—è—Å–Ω–æ|—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é)\b',
        r'\b(?:–¥–∞–≤–∞–π—Ç–µ|–º–æ–∂–µ—Ç–µ|—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ|–æ–ø–∏—à–∏—Ç–µ|–æ–±—ä—è—Å–Ω–∏—Ç–µ)\b',
        r'\b(?:–Ω–∏—á–µ–≥–æ\s+—Å—Ç—Ä–∞—à–Ω–æ–≥–æ|–≤—Å–µ\s+(?:–Ω–æ—Ä–º–∞–ª—å–Ω–æ|—Ö–æ—Ä–æ—à–æ|–≤\s+–ø–æ—Ä—è–¥–∫–µ))\b',
        r'\b(?:–Ω–µ\s+—Å—Ç—Ä–∞—à–Ω–æ|–Ω–µ\s+–±–µ–¥–∞|–ª–∞–¥–Ω–æ|–Ω–æ—Ä–º–∞–ª—å–Ω–æ)\b',
        r'\b(?:–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ|–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ|–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ)\b',
    ]

    has_journalist_addressing = any(
        re.search(p, text_lower) for p in journalist_addressing_patterns
    )

    speaker_monologue_antipatterns = [
        r'\b—è\s+(?:–¥—É–º–∞—é|—Å—á–∏—Ç–∞—é|–ø–æ–ª–∞–≥–∞—é|—É–≤–µ—Ä–µ–Ω|–∑–Ω–∞—é)\b',
        r'\b(?:–¥–µ–ª–æ\s+–≤\s+—Ç–æ–º|—Å—É—Ç—å\s+–≤\s+—Ç–æ–º|–ø—Ä–æ–±–ª–µ–º–∞\s+–≤\s+—Ç–æ–º)\b',
        r'\b(?:–≤–æ-–ø–µ—Ä–≤—ã—Ö|–≤–æ-–≤—Ç–æ—Ä—ã—Ö|–≤-—Ç—Ä–µ—Ç—å–∏—Ö)\b',
        r'\b(?:–ø–æ—ç—Ç–æ–º—É|—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ|—Ç–∞–∫–∏–º\s+–æ–±—Ä–∞–∑–æ–º)\b',
    ]

    has_speaker_monologue = any(
        re.search(p, text_lower) for p in speaker_monologue_antipatterns
    )

    return (word_count < 15 and 
            has_journalist_addressing and 
            not has_speaker_monologue)

def has_speaker_monologue_markers(text):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –º–æ–Ω–æ–ª–æ–≥–∞ –°–ø–∏–∫–µ—Ä–∞

    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

    Returns:
        bool: True –µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã –º–æ–Ω–æ–ª–æ–≥–∞ –°–ø–∏–∫–µ—Ä–∞
    """
    text_lower = text.lower()

    speaker_monologue_patterns = [
        r'\b—è\s+(?:–¥—É–º–∞—é|—Å—á–∏—Ç–∞—é|–ø–æ–ª–∞–≥–∞—é|—É–≤–µ—Ä–µ–Ω|—É–±–µ–∂–¥–µ–Ω|—É–±–µ–∂–¥—ë–Ω|–∑–Ω–∞—é|–ø–æ–Ω–∏–º–∞—é|–≤–∏–∂—É|–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é|–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é)\b',
        r'\b(?:—É\s+–º–µ–Ω—è|–º–Ω–µ|–º–µ–Ω—è|–º–Ω–æ–π|–º–Ω–æ—é|–º–æ—ë|–º–æ—è|–º–æ–∏|–º–æ–µ|–º–æ–µ–≥–æ|–º–æ–µ–π|–º–æ–∏—Ö|–º–æ–∏–º|–º–æ–∏–º–∏)\b',
        r'\b(?:–¥–µ–ª–æ\s+–≤\s+—Ç–æ–º|—Å—É—Ç—å\s+–≤\s+—Ç–æ–º|–ø—Ä–æ–±–ª–µ–º–∞\s+–≤\s+—Ç–æ–º|–≤–æ–ø—Ä–æ—Å\s+–≤\s+—Ç–æ–º|—Å–º—ã—Å–ª\s+–≤\s+—Ç–æ–º)\b',
        r'\b(?:–≤–æ-–ø–µ—Ä–≤—ã—Ö|–≤–æ-–≤—Ç–æ—Ä—ã—Ö|–≤-—Ç—Ä–µ—Ç—å–∏—Ö|–≤-—á–µ—Ç–≤–µ—Ä—Ç—ã—Ö|–≤-—á–µ—Ç–≤—ë—Ä—Ç—ã—Ö|–≤-–ø—è—Ç—ã—Ö)\b',
        r'\b(?:–ø–æ—ç—Ç–æ–º—É|—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ|—Ç–∞–∫–∏–º\s+–æ–±—Ä–∞–∑–æ–º|–≤\s+—Å–≤—è–∑–∏\s+—Å\s+—ç—Ç–∏–º|–æ—Ç—Å—é–¥–∞|–∏–∑\s+—ç—Ç–æ–≥–æ\s+—Å–ª–µ–¥—É–µ—Ç)\b',
        r'\b(?:–Ω–∞\s+–º–æ–π\s+–≤–∑–≥–ª—è–¥|–ø–æ\s+–º–æ–µ–º—É\s+–º–Ω–µ–Ω–∏—é|–∫–∞–∫\s+–º–Ω–µ\s+–∫–∞–∂–µ—Ç—Å—è|—è\s+–±—ã\s+—Å–∫–∞–∑–∞–ª|—è\s+–±—ã\s+–æ—Ç–º–µ—Ç–∏–ª)\b',
        r'\b—è\s+(?:–º–æ–≥—É|–¥–æ–ª–∂–µ–Ω|—Ö–æ—á—É|–±—É–¥—É|—Å—Ç–∞–ª|–Ω–∞—á–∞–ª|–ø—ã—Ç–∞—é—Å—å|—Å—Ç–∞—Ä–∞—é—Å—å)\b',
    ]

    return any(re.search(p, text_lower) for p in speaker_monologue_patterns)

def get_previous_monologue_duration(segments, index, speaker):
    """
    üÜï v16.8: –í—ã—á–∏—Å–ª—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –º–æ–Ω–æ–ª–æ–≥–∞ —Å–ø–∏–∫–µ—Ä–∞
    
    Args:
        segments: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
        index: –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
        speaker: –°–ø–∏–∫–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    Returns:
        –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–æ–Ω–æ–ª–æ–≥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (0 –µ—Å–ª–∏ –Ω–µ—Ç –º–æ–Ω–æ–ª–æ–≥–∞)
    """
    if index == 0:
        return 0
    
    # –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–æ–Ω–æ–ª–æ–≥–∞
    monologue_start_idx = index - 1
    for i in range(index - 1, -1, -1):
        if segments[i].get('speaker') != speaker:
            monologue_start_idx = i + 1
            break
        if i == 0:
            monologue_start_idx = 0
    
    # –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    if monologue_start_idx < index:
        duration = (segments[index - 1].get('end', 0) - 
                   segments[monologue_start_idx].get('start', 0))
        return duration
    
    return 0

def is_continuation_phrase(text):
    """
    üÜï v16.8: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ—Ä–∞–∑–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º –º–æ–Ω–æ–ª–æ–≥–∞
    
    –§—Ä–∞–∑—ã —Ç–∏–ø–∞ "–¢–æ –µ—Å—Ç—å", "–í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏", "–ö—Ä–æ–º–µ —Ç–æ–≥–æ" –æ–±—ã—á–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç
    –ø—Ä–µ–¥—ã–¥—É—â—É—é –º—ã—Å–ª—å, –∞ –Ω–µ –Ω–∞—á–∏–Ω–∞—é—Ç –Ω–æ–≤—É—é —Ç–µ–º—É –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞.
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    Returns:
        True –µ—Å–ª–∏ —ç—Ç–æ —Ñ—Ä–∞–∑–∞-–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
    """
    text_lower = text.lower().strip()
    
    continuation_patterns = [
        r'^—Ç–æ\s+–µ—Å—Ç—å\b',
        r'^–≤\s+—á–∞—Å—Ç–Ω–æ—Å—Ç–∏\b',
        r'^–∫—Ä–æ–º–µ\s+—Ç–æ–≥–æ\b',
        r'^–ø–æ–º–∏–º–æ\s+—ç—Ç–æ–≥–æ\b',
        r'^—Ç–∞–∫–∂–µ\b',
        r'^–±–æ–ª–µ–µ\s+—Ç–æ–≥–æ\b',
        r'^–∫\s+—Ç–æ–º—É\s+–∂–µ\b',
        r'^–≤–¥–æ–±–∞–≤–æ–∫\b',
        r'^–ø—Ä–∏\s+—ç—Ç–æ–º\b',
        r'^–æ–¥–Ω–∞–∫–æ\b',
        r'^–Ω–æ\b',
        r'^–∞\s+(?:—Ç–∞–∫–∂–µ|–µ—â–µ|–µ—â—ë)\b',
    ]
    
    return any(re.match(p, text_lower) for p in continuation_patterns)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –í–ï–°–û–í–ê–Ø –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø v15 + v16.8 PROTECTION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def apply_speaker_classification_v15(segments, speaker_surname, debug=False):
    """
    v16.8: –í–µ—Å–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤ —Å –∑–∞—â–∏—Ç–æ–π –¥–ª–∏–Ω–Ω—ã—Ö –º–æ–Ω–æ–ª–æ–≥–æ–≤

    üÜï v16.8 –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
    - Long Monologue Protection: –Ω–µ –ø–µ—Ä–µ–∞—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –º–æ–Ω–æ–ª–æ–≥–æ–≤ >60s
    - Continuation Phrase Detection: "–¢–æ –µ—Å—Ç—å", "–í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏" –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
    - Context-aware classification: —É—á—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤

    Args:
        segments: –°–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ merge_replicas()
        speaker_surname: –§–∞–º–∏–ª–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏–∫–µ—Ä–∞
        debug: –ï—Å–ª–∏ True, –≤—ã–≤–æ–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

    Returns:
        (segments, stats) - –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    """

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç–∞
    JOURNALIST_PATTERNS = {
        'addressing': [
            (r'\b(—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ|–æ–±—ä—è—Å–Ω–∏—Ç–µ|–ø–æ—è—Å–Ω–∏—Ç–µ|—É—Ç–æ—á–Ω–∏—Ç–µ|—Å–∫–∞–∂–∏—Ç–µ)\b', 3),
            (r'\b(–≤—ã\s+(?:–º–æ–∂–µ—Ç–µ|–∑–Ω–∞–µ—Ç–µ|–ø–æ–º–Ω–∏—Ç–µ|—Å—á–∏—Ç–∞–µ—Ç–µ|–¥—É–º–∞–µ—Ç–µ))\b', 2),
            (r'\b(–∫–∞–∫\s+–≤—ã\s+(?:—Å—á–∏—Ç–∞–µ—Ç–µ|–¥—É–º–∞–µ—Ç–µ|–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ))\b', 3),
            (r'\b–ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å\b', 5),
            (r'\b(–¥–∞–≤–∞–π—Ç–µ|–ø–µ—Ä–µ—Ö–æ–¥–∏–º|–Ω–∞—á–Ω–µ–º|–ø—Ä–æ–¥–æ–ª–∂–∏–º)\b', 2),
        ],
        'questions': [
            (r'\?$', 1),  # –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫ –≤ –∫–æ–Ω—Ü–µ
            (r'^(–∫–∞–∫|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º|–∫–æ–≥–¥–∞|–≥–¥–µ|–∫—Ç–æ|—á—Ç–æ)\s', 2),  # –í–æ–ø—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–µ
            (r'\b(–Ω–µ\s+—Ç–∞–∫|–≤–µ—Ä–Ω–æ|–ø—Ä–∞–≤–∏–ª—å–Ω–æ)\s*\?', 2),
        ],
        'commands': [
            (r'\b(—Å–º–æ—Ç—Ä–∏–º|—Å–ª—É—à–∞–µ–º|–æ—Ç–≤–µ—á–∞–µ–º)\s+(?:–Ω–∞|–≤)', 2),
            (r'\b–º—ã\s+(?:—Å–µ–π—á–∞—Å|—Ç–µ–ø–µ—Ä—å)\s+(?:–æ—Ç–≤–µ—á–∞–µ–º|–≥–æ–≤–æ—Ä–∏–º|–æ–±—Å—É–∂–¥–∞–µ–º)\b', 2),
        ],
    }

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –°–ø–∏–∫–µ—Ä–∞
    SPEAKER_PATTERNS = {
        'monologue': [
            (r'\b(—É\s+–º–µ–Ω—è|–º–Ω–µ|—è\s+(?:—Å—á–∏—Ç–∞—é|–¥—É–º–∞—é|–ø–æ–ª–∞–≥–∞—é|–ø–æ–º–Ω—é))\b', 2),
            (r'\b(–Ω–∞\s+–º–æ–π\s+–≤–∑–≥–ª—è–¥|–ø–æ\s+–º–æ–µ–º—É\s+–º–Ω–µ–Ω–∏—é)\b', 3),
            (r'\b(–º–æ—ë|–º–æ—è|–º–æ–π|–º–æ–∏)\s+(?:–º–Ω–µ–Ω–∏–µ|–æ–ø—ã—Ç|–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ|—Ä–∞–±–æ—Ç–∞)\b', 3),
        ],
        'facts': [
            (r'\b\d{4}\s*–≥–æ–¥', 1),  # –î–∞—Ç—ã
            (r'\b(?:–æ–ø–µ—Ä–∞—Ü–∏—è|—Å—Ä–∞–∂–µ–Ω–∏–µ|–±–∏—Ç–≤–∞|—Ñ—Ä–æ–Ω—Ç|–∞—Ä–º–∏—è)\b', 1),
        ],
    }

    # –ó–∞—â–∏—Ç—ã –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
    PROTECTIONS = {
        'journalist_not_speaker': [
            # "–ú—ã" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–µ –ª–∏—á–Ω–æ–≥–æ –æ–ø—ã—Ç–∞
            (r'\b–º—ã\s+(?:—Å–µ–π—á–∞—Å|—Ç–µ–ø–µ—Ä—å|—Ç—É—Ç|–∑–¥–µ—Å—å)\s', -3),
            # –û–±—Ä–∞—â–µ–Ω–∏–µ "–≤—ã" –∫ –°–ø–∏–∫–µ—Ä—É
            (r'\b–≤—ã\s+(?:–ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å|—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ|–æ–±—ä—è—Å–Ω–∏—Ç–µ)\b', -5),
        ],
    }

    def calculate_speaker_score(text, current_speaker):
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Å–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–ø–∏–∫–µ—Ä–∞"""
        text_lower = text.lower()
        journalist_score = 0
        speaker_score = 0
        details = []

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç–∞
        for category, patterns in JOURNALIST_PATTERNS.items():
            for pattern, weight in patterns:
                if re.search(pattern, text_lower, re.I):
                    journalist_score += weight
                    details.append(f"J:{category}:+{weight}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –°–ø–∏–∫–µ—Ä–∞
        for category, patterns in SPEAKER_PATTERNS.items():
            for pattern, weight in patterns:
                if re.search(pattern, text_lower, re.I):
                    speaker_score += weight
                    details.append(f"S:{category}:+{weight}")

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞—â–∏—Ç—ã
        for pattern, weight in PROTECTIONS['journalist_not_speaker']:
            if re.search(pattern, text_lower, re.I):
                speaker_score += weight  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–µ—Å —É–º–µ–Ω—å—à–∞–µ—Ç –≤–µ—Å –°–ø–∏–∫–µ—Ä–∞
                details.append(f"PROTECT:S:{weight}")

        return journalist_score, speaker_score, details

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = {
        'total_checked': 0,
        'changed_to_journalist': 0,
        'changed_to_speaker': 0,
        'skipped_protections': 0,
        'skipped_monologue_context': 0,  # üÜï v16.8
        'details': []
    }

    if debug:
        print("\n" + "="*80)
        print("üéØ v16.8: –í–ï–°–û–í–ê–Ø –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø + MONOLOGUE PROTECTION")
        print("="*80)

    for i, seg in enumerate(segments):
        text = seg.get('text', '').strip()
        current_speaker = seg.get('speaker', '')
        time = seg.get('time', '00:00:00')
        word_count = len(text.split())

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ –∫–æ–º–∞–Ω–¥—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        if word_count < SPEAKER_CLASSIFICATION_MIN_WORDS or current_speaker == '–û–ø–µ—Ä–∞—Ç–æ—Ä':
            continue

        stats['total_checked'] += 1

        # üÜï v16.8: LONG MONOLOGUE PROTECTION
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–æ–Ω–æ–ª–æ–≥–∞
        prev_monologue_duration = get_previous_monologue_duration(segments, i, current_speaker)
        
        if prev_monologue_duration > 60:
            # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–æ–Ω–æ–ª–æ–≥ >60s, –Ω–µ –ø–µ—Ä–µ–∞—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ 3 —Å–µ–≥–º–µ–Ω—Ç–∞
            segments_to_protect = 3
            monologue_end_idx = i - 1
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–π –∑–æ–Ω–µ
            protected = False
            for j in range(max(0, monologue_end_idx - segments_to_protect + 1), monologue_end_idx + 1):
                if j == i:
                    protected = True
                    break
            
            if protected or is_continuation_phrase(text):
                if debug:
                    protection_reason = "continuation phrase" if is_continuation_phrase(text) else f"after {prev_monologue_duration:.1f}s monologue"
                    print(f"\n  üõ°Ô∏è [{time}] MONOLOGUE PROTECTION ({protection_reason})")
                    print(f"     –¢–µ–∫—Å—Ç: {text[:80]}...")
                
                stats['skipped_monologue_context'] += 1
                continue

        j_score, s_score, details = calculate_speaker_score(text, current_speaker)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤–µ—Å–æ–≤)
        CONFIDENCE_THRESHOLD = SPEAKER_CLASSIFICATION_CONFIDENCE_THRESHOLD

        # –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç ‚Üí –°–ø–∏–∫–µ—Ä
        if current_speaker == '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç' and s_score > j_score + CONFIDENCE_THRESHOLD:
            if debug:
                print(f"\n  üîÑ [{time}] –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç ‚Üí {speaker_surname}")
                print(f"     –í–µ—Å–∞: J={j_score}, S={s_score}")
                print(f"     –ü–∞—Ç—Ç–µ—Ä–Ω—ã: {', '.join(details)}")
                print(f"     –¢–µ–∫—Å—Ç: {text[:80]}...")

            seg['speaker'] = speaker_surname
            stats['changed_to_speaker'] += 1
            stats['details'].append({
                'time': time,
                'from': '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç',
                'to': speaker_surname,
                'j_score': j_score,
                's_score': s_score,
                'text': text[:100]
            })

        # –°–ø–∏–∫–µ—Ä ‚Üí –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç
        elif current_speaker == speaker_surname and j_score > s_score + CONFIDENCE_THRESHOLD:
            if debug:
                print(f"\n  üîÑ [{time}] {speaker_surname} ‚Üí –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç")
                print(f"     –í–µ—Å–∞: J={j_score}, S={s_score}")
                print(f"     –ü–∞—Ç—Ç–µ—Ä–Ω—ã: {', '.join(details)}")
                print(f"     –¢–µ–∫—Å—Ç: {text[:80]}...")

            seg['speaker'] = '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç'
            stats['changed_to_journalist'] += 1
            stats['details'].append({
                'time': time,
                'from': speaker_surname,
                'to': '–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç',
                'j_score': j_score,
                's_score': s_score,
                'text': text[:100]
            })

    if debug:
        print("="*80)
        print(f"‚úÖ v16.8: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        print(f"   –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: {stats['total_checked']}")
        print(f"   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {stats['changed_to_journalist'] + stats['changed_to_speaker']}")
        print(f"   ‚Ä¢ –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç ‚Üí –°–ø–∏–∫–µ—Ä: {stats['changed_to_speaker']}")
        print(f"   ‚Ä¢ –°–ø–∏–∫–µ—Ä ‚Üí –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç: {stats['changed_to_journalist']}")
        print(f"   ‚Ä¢ üÜï –ü—Ä–æ–ø—É—â–µ–Ω–æ (–º–æ–Ω–æ–ª–æ–≥ >60s): {stats['skipped_monologue_context']}")
        print(f"   ‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ (–∑–∞—â–∏—Ç—ã): {stats['skipped_protections']}")
        print("="*80)
        print()

    return segments, stats
