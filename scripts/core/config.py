#!/usr/bin/env python3
"""
core/config.py - Константы и паттерны для v16.7
"""

import re
import sys
from pathlib import Path

# ═══════════════════════════════════════════════════════════════════════════
# ВЕРСИЯ
# ═══════════════════════════════════════════════════════════════════════════

VERSION = "16.7"
VERSION_NAME = "Auto Test-Results Copy"

# ═══════════════════════════════════════════════════════════════════════════
# HUGGING FACE TOKEN
# 🔒 v16.7.1: Токен перенесён в secrets.py (не в Git)
# ═══════════════════════════════════════════════════════════════════════════

try:
    from .secrets import HF_TOKEN
except ImportError:
    print("=" * 70)
    print("❌ ОШИБКА: Файл secrets.py не найден!")
    print()
    print("📋 Создай файл secrets.py из шаблона:")
    print("   1. Скопируй: scripts/core/secrets.example.py → secrets.py")
    print("   2. Получи токен: https://huggingface.co/settings/tokens")
    print("   3. Вставь в secrets.py: HF_TOKEN = \"hf_твой_токен\"")
    print("=" * 70)
    sys.exit(1)

# ═══════════════════════════════════════════════════════════════════════════
# РЕЖИМЫ
# ═══════════════════════════════════════════════════════════════════════════

HALLUCINATION_CLEANUP_MODE = "context"

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ ГАЛЛЮЦИНАЦИЙ
# 🔧 v16.0: УДАЛЁН паттерн "Давайте снять" (это валидная фраза)
# ═══════════════════════════════════════════════════════════════════════════

HALLUCINATION_PATTERNS = [
    r'\d+\s+вопрос\.?',
    # r'Давайте\s+(?:снять|начнем|начнём)',  ← УДАЛЕНО в v16!
    r'^Угу\.?$',
    r'^Ага\.?$',
    r'^Хм+\.?$',
    r'^Э+\.?$',
    r'^М+\.?$',
]

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ ВОПРОСОВ
# ═══════════════════════════════════════════════════════════════════════════

QUESTION_PATTERN = r'\b((?:\d+|первый|второй|третий|четвертый|четвёртый|пятый|шестой|седьмой|восьмой|девятый|десятый|одиннадцатый|двенадцатый|тринадцатый|четырнадцатый|пятнадцатый|шестнадцатый|семнадцатый|восемнадцатый|девятнадцатый|двадцатый))\s+вопрос\b'

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ ЖУРНАЛИСТА
# 🆕 v16.0: Добавлены для защиты от ошибочной реатрибуции
# ═══════════════════════════════════════════════════════════════════════════

JOURNALIST_START_PATTERNS = [
    r'\b(?:смотрим|смотрите)\s+(?:на\s+меня|сюда)\b',
    r'\bпредставьтесь\b',
    r'\b(?:мы|я)\s+сейчас\s+(?:отвечаем|записываем|снимаем)\b',
    r'\bкамера\s+(?:идет|идёт|пошла)\b',
    r'\bначали\s+(?:запись|снимать)\b',
    r'\b(?:у\s+нас|наш)\s+сериал\b',
]

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ ОПЕРАТОРА
# ═══════════════════════════════════════════════════════════════════════════

OPERATOR_PATTERNS = r'(?:' \
    r'камера\s+(?:идет|идёт|пошла)|' \
    r'поехали|пишем|начали|записываем|' \
    r'камера(?:\s|$)|' \
    r'запись' \
    r')'

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ ДЛЯ ОПРЕДЕЛЕНИЯ РОЛЕЙ
# ═══════════════════════════════════════════════════════════════════════════

JOURNALIST_PATTERNS = r'(?:' \
    r'\d+\s+вопрос|первый\s+вопрос|второй\s+вопрос|третий\s+вопрос|' \
    r'представьтесь?\s+пожалуйста|' \
    r'как\s+вас\s+будут\s+расписывать|' \
    r'мы\s+сейчас\s+отвечаем\s+на\s+вопросы|' \
    r'у\s+нас\s+сериал|' \
    r'тема\s+нашего|' \
    r'представляетесь|' \
    r'расскажите?|опишите|объясните|' \
    r'что\s+вы\s+(?:думаете|считаете)|' \
    r'как\s+вы\s+(?:думаете|считаете)' \
    r')\b|\?$'

# ═══════════════════════════════════════════════════════════════════════════
# ПАТТЕРНЫ КОМАНД ЖУРНАЛИСТА
# ═══════════════════════════════════════════════════════════════════════════

JOURNALIST_COMMAND_PATTERNS = [
    r'\bне\s+переговорите\b',
    r'\bпереговорите\b',
    r'\bповторите\b',
    r'\bеще\s+раз\b',
    r'\bс\s+начала\b',
    r'\bзаново\b',
]

# ═══════════════════════════════════════════════════════════════════════════
# ПОРОГИ И ЛИМИТЫ
# ═══════════════════════════════════════════════════════════════════════════

# Gap detection
GAP_THRESHOLD = 3.0  # секунды

# Force transcribe
FORCE_TRANSCRIBE_NO_SPEECH_THRESHOLD = 0.2  # 🆕 v16: Было 0.3
FORCE_TRANSCRIBE_TEMPERATURE = 0.0
FORCE_TRANSCRIBE_BEAM_SIZE = 5
FORCE_TRANSCRIBE_COMPRESSION_RATIO = 1.2

# Similarity
TEXT_SIMILARITY_THRESHOLD = 0.85
TEXT_SIMILARITY_THRESHOLD_HIGH = 0.95

# Auto-merge
AUTO_MERGE_PAUSE_THRESHOLD = 5.0  # секунды

# Speaker classification v15
SPEAKER_CLASSIFICATION_CONFIDENCE_THRESHOLD = 3
SPEAKER_CLASSIFICATION_MIN_WORDS = 5

# ═══════════════════════════════════════════════════════════════════════════
# ADAPTIVE VAD THRESHOLDS
# ═══════════════════════════════════════════════════════════════════════════

VAD_THRESHOLDS = {
    300: 0.65,
    600: 0.70,
    900: 0.75,
    'default': 0.80
}
