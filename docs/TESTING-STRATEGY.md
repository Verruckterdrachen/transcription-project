# TESTING-STRATEGY.md — Стратегия тестирования
# Обновлено: 2026-02-20

Философия:
- **Real tests > Simulations > Integration > Unit**
- Unit tests — только для изолированных утилит без зависимостей от пайплайна
- Любой баг → сначала real test + debug → симуляция (если текстовый) → фикс

---

## 1. Уровни тестирования

### 1.1 Real tests (обязательны)
Полный запуск `scripts/transcribe.py` на реальном аудио:
- проверка JSON и TXT
- проверка 8 пунктов `VALIDATION.md`
- сравнение с golden-dataset

### 1.2 Симуляции (при текстовых багах)
Прогон реального текста через реальную функцию — **без полного пайплайна**.

Отличие от unit-тестов: симуляция использует реальные фрагменты из debug-логов
и проверяет поведение функции на граничных кейсах из боевых данных.

**Когда создавать:**
При баге в любой функции текстовой обработки:
`clean_loops`, `clean_hallucinations_from_text`, `join_texts_deduplicated`,
`_count_meaningful` и подобных.

**Где хранить:**
tests/simulations/sim_bug{NN}_{функция}.py

text

**Что должна содержать:**
- `OLD` версию функции (до фикса) — воспроизводит баг
- `NEW` версию функции (после фикса) — проверяет исправление
- `TEST_CASES` из реальных debug-логов + `tests/corpus/`
- Проверку вспомогательных хелперов (`_count_meaningful` и аналогов)
- Итоговый счётчик `N/N тестов пройдено` — должен быть GREEN

**Правило накопления:**
❌ ЗАПРЕЩЕНО удалять симуляции после закрытия бага.
Каждая симуляция — регрессионный тест для будущих фиксов.
При следующем баге в той же функции: добавить новые TEST_CASES в существующий файл.

**Корпус реальных текстов:**
`tests/corpus/` — накапливает реальные MERGE-блоки из разных интервью.
Чем больше корпус → тем надёжнее симуляция → тем меньше шанс пропустить
граничный кейс на коротком тестовом фрагменте.

### 1.3 Integration tests (по необходимости)
Проверка взаимодействия нескольких модулей:
- например, `replica_merger` + `txt_export`
- выполняются через полный пайплайн или отдельный сценарий

### 1.4 Unit tests (точечно)
Только для:
- чистых утилит (regex, парсинг, форматирование)
- функций без зависимостей от других модулей и внешних систем

---

## 2. Когда unit-тесты НЕ НУЖНЫ

Не создаём unit-тесты для:
- багов на стыке модулей (`replica_merger` + `txt_export`)
- логики, сильно зависящей от реальных данных пайплайна
- сложных взаимодействий между несколькими шагами

**Причина:** такие баги проходят через unit-тесты и проявляются только на real test
→ ложное чувство безопасности.

---

## 3. Когда unit-тесты ОБЯЗАТЕЛЬНЫ

Урок БАГ #3: утилиты парсинга должны покрываться unit-тестами.

**Примеры, где unit-тесты нужны:**
- `parse_sentences(text)` — парсинг предложений
- `seconds_to_hms(seconds)` — форматирование timestamp'ов
- Любой helper, который:
  - не зависит от JSON / Pyannote / Whisper
  - принимает и возвращает «чистые» данные (строки, числа, списки, dict)

**Где хранить:**
tests/unit/test_{модуль}.py

text

---

## 4. Структура папки tests/

tests/
simulations/
sim_bug27_clean_loops.py ← БАГ #27, clean_loops (5/5 GREEN)
sim_bug{NN}_{func}.py ← будущие баги
unit/
test_regex_patterns.py ← regex-утилиты
corpus/
edge_cases.txt ← граничные кейсы для ручной проверки
clean_loops_real_texts.txt ← реальные MERGE-блоки для симуляций

text

⚠️ `test_clean_loops_sim.py` из корня `scripts/` — перенести в
`tests/simulations/sim_bug27_clean_loops.py` при следующем коммите.

---

## 5. Стратегия при новом баге

1. Воспроизведи баг через real test:
   ```bash
   python scripts/transcribe.py
Сохрани JSON/TXT/лог в test-results/latest/.

С помощью debug-checkpoint'ов найди этап, где всё ломается.

Если корень в текстовой функции:

создай tests/simulations/sim_bug{NN}_{func}.py

добавь TEST_CASES из debug-лога (минимум 3: ложный кейс + 2 реальных)

добавь фрагменты в tests/corpus/ для будущих прогонов

добей Simulation до GREEN

затем фикс кода → real test

Если корень во взаимодействии модулей:

НЕ трать время на unit-тесты и симуляции

правь код, опираясь на real test + debug

опиши кейс в KNOWN-ISSUES.md

Если корень в изолированной утилите:

выдели в отдельную функцию (если ещё нет)

напиши unit-тест в tests/unit/

почини код → тест GREEN → real test

6. Чеклист перед коммитом
 Есть real test на проблемном аудио

 Все 8 пунктов VALIDATION.md — GREEN

 При текстовом баге: симуляция в tests/simulations/ — GREEN

 При новой утилите: unit-тест в tests/unit/ — GREEN

 VERSION.md обновлён (версия + ROOT CAUSE + FIX)

 KNOWN-ISSUES.md обновлён

 CHANGELOG.md — новый блок prepend в начало