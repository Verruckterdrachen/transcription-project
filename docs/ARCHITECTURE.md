# ๐๏ธ ะััะธัะตะบัััะฐ ะฟัะพะตะบัะฐ

ะะพะดัะพะฑะฝะพะต ะพะฟะธัะฐะฝะธะต pipeline ะพะฑัะฐะฑะพัะบะธ ะฐัะดะธะพ-ะธะฝัะตัะฒัั.

---

## ๐ ะะฑัะฐั ััะตะผะฐ Pipeline

โโโโโโโโโโโโโโโโโโโ
โ WAV ัะฐะนะป โ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 1 โ Pyannote Audio 3.1
โ ะะธะฐัะธะทะฐัะธั โ ะะฟัะตะดะตะปะตะฝะธะต ะบัะพ ะธ ะบะพะณะดะฐ ะณะพะฒะพัะธั
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 2 โ Whisper large-v3-turbo
โ ะขัะฐะฝัะบัะธะฑะฐัะธั โ ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ัะตัะธ ะฒ ัะตะบัั
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 3 โ Alignment
โ ะััะฐะฒะฝะธะฒะฐะฝะธะต โ ะกะฒัะทั ัะตะบััะฐ ั ัะฟะธะบะตัะฐะผะธ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 4 โ Corrections
โ ะะพััะตะบัะธะธ โ ะัะฟัะฐะฒะปะตะฝะธะต ะพัะธะฑะพะบ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 5 โ GAP Detection + Force Transcribe
โ ะะฑัะฐะฑะพัะบะฐ ะฟะฐัะท โ ะะฐะฟะพะปะฝะตะฝะธะต ะฟัะพะฟััะตะฝะฝัั ัะตะณะผะตะฝัะพะฒ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 6 โ Replica Merger
โ ะกะปะธัะฝะธะต ัะตะฟะปะธะบ โ ะะฑัะตะดะธะฝะตะฝะธะต ัะพัะตะดะฝะธั ัะตะณะผะตะฝัะพะฒ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 7 โ Speaker Classification v15
โ ะะปะฐััะธัะธะบะฐัะธั โ ะะตัะพะฒะฐั ัะธััะตะผะฐ ะพะฟัะตะดะตะปะตะฝะธั ัะฟะธะบะตัะฐ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 8 โ Text-based Corrections
โ ะขะตะบััะพะฒัะต โ ะัะฟัะฐะฒะปะตะฝะธั ะฝะฐ ะพัะฝะพะฒะต ะบะพะฝัะตะฝัะฐ
โ ะธัะฟัะฐะฒะปะตะฝะธั โ
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ ะญะขะะ 9 โ Validation + Auto-merge
โ ะะฐะปะธะดะฐัะธั โ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะธ ัะปะธัะฝะธะต
โโโโโโโโโโฌโโโโโโโโโ
โ
โผ
โโโโโโโโโโโโโโโโโโโ
โ JSON + TXT โ ะญะบัะฟะพัั ัะตะทัะปััะฐัะพะฒ
โโโโโโโโโโโโโโโโโโโ


---

## ๐ ะญะขะะ 1: ะะธะฐัะธะทะฐัะธั

**ะะพะดัะปั:** `scripts/core/diarization.py`  
**ะัะฝะพะฒะฝะฐั ััะฝะบัะธั:** `diarize_audio()`

### ะะฟะธัะฐะฝะธะต
ะะฟัะตะดะตะปัะตั ะฒัะตะผะตะฝะฝัะต ะธะฝัะตัะฒะฐะปั, ะบะพะณะดะฐ ะณะพะฒะพัะธั ะบะฐะถะดัะน ัะฟะธะบะตั, ะธัะฟะพะปัะทัั Pyannote Audio 3.1.

### ะัะพัะตัั
1. ะะฐะณััะทะบะฐ ะฐัะดะธะพ ัะฐะนะปะฐ
2. ะัะธะผะตะฝะตะฝะธะต ะดะธะฐัะธะทะฐัะธะธ (min_speakers=2, max_speakers=3)
3. ะะพะปััะตะฝะธะต timeline ั ะผะตัะบะฐะผะธ ัะฟะธะบะตัะพะฒ
4. ะััะธัะปะตะฝะธะต ััะฐัะธััะธะบะธ ะฟะพ ะบะฐะถะดะพะผั ัะฟะธะบะตัั

### ะััะพะด
```python
{
    "SPEAKER_00": {
        "total_time": 1234.5,  # ัะตะบัะฝะดั
        "num_segments": 89
    },
    "SPEAKER_01": {
        "total_time": 2345.6,
        "num_segments": 152
    }
}

ะะฐัะฐะผะตััั
min_speakers: 2 (ะััะฝะฐะปะธัั + ะญะบัะฟะตัั)

max_speakers: 3 (+ ะะฟะตัะฐัะพั, ะตัะปะธ ะตััั)

Device: CUDA (ะตัะปะธ ะดะพัััะฟะฝะฐ) ะธะปะธ CPU

๐ค ะญะขะะ 2: ะขัะฐะฝัะบัะธะฑะฐัะธั
ะะพะดัะปั: scripts/core/transcription.py
ะัะฝะพะฒะฝะฐั ััะฝะบัะธั: transcribe_audio()

ะะฟะธัะฐะฝะธะต
ะัะตะพะฑัะฐะทัะตั ัะตัั ะฒ ัะตะบัั ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Whisper large-v3-turbo.

ะัะพัะตัั
ะะฐะณััะทะบะฐ ะผะพะดะตะปะธ Whisper

ะัะธะผะตะฝะตะฝะธะต ะฐะดะฐะฟัะธะฒะฝะพะณะพ VAD threshold

ะขัะฐะฝัะบัะธะฑะฐัะธั ั ะฟะฐัะฐะผะตััะฐะผะธ:

language="ru"

temperature=0.0 (ะดะตัะตัะผะธะฝะธะทะผ)

beam_size=5 (ะบะฐัะตััะฒะพ)

VAD Threshold (ะฐะดะฐะฟัะธะฒะฝัะน)

if duration < 600:  # <10 ะผะธะฝ
    vad = 0.3
elif duration < 1800:  # 10-30 ะผะธะฝ
    vad = 0.4
else:  # >30 ะผะธะฝ
    vad = 0.5

{
    "text": "ะฟะพะปะฝัะน ัะตะบัั",
    "segments": [
        {
            "start": 0.0,
            "end": 5.3,
            "text": "ะะพะฑััะน ะดะตะฝั!",
            "confidence": 0.95
        },
        ...
    ]
}

๐ ะญะขะะ 3: ะััะฐะฒะฝะธะฒะฐะฝะธะต
ะะพะดัะปั: scripts/core/alignment.py
ะัะฝะพะฒะฝะฐั ััะฝะบัะธั: align_whisper_with_diarization()

ะะฟะธัะฐะฝะธะต
ะกะฒัะทัะฒะฐะตั ัะตะบัั ะพั Whisper ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ ัะฟะธะบะตัะพะฒ ะพั Pyannote.

ะัะพัะตัั
ะะปั ะบะฐะถะดะพะณะพ ัะตะณะผะตะฝัะฐ Whisper ะฝะฐัะพะดะธั ะฟะตัะตะบัััะธะต ั ะดะธะฐัะธะทะฐัะธะตะน

ะะฟัะตะดะตะปัะตั ะพัะฝะพะฒะฝะพะณะพ ัะฟะธะบะตัะฐ ะฟะพ ะผะฐะบัะธะผะฐะปัะฝะพะผั ะฟะตัะตะบัััะธั

ะะดะตะฝัะธัะธัะธััะตั ัะพะปั ัะฟะธะบะตัะฐ (ะััะฝะฐะปะธัั/ะญะบัะฟะตัั/ะะฟะตัะฐัะพั)

ะะพะณะธะบะฐ ะธะดะตะฝัะธัะธะบะฐัะธะธ ัะพะปะตะน

# ะกะฟะธะบะตั ั ะผะตะฝััะธะผ total_time โ ะััะฝะฐะปะธัั (ะพะฑััะฝะพ ะผะตะฝััะต ะณะพะฒะพัะธั)
# ะกะฟะธะบะตั ั ะฑะพะปััะธะผ total_time โ ะญะบัะฟะตัั (ะดะปะธะฝะฝัะต ะผะพะฝะพะปะพะณะธ)
# ะะพะฟะพะปะฝะธัะตะปัะฝัะน ัะฟะธะบะตั โ ะะฟะตัะฐัะพั (ัะตะดะบะธะต ัะตะฟะปะธะบะธ)

ะััะพะด

{
    "start": 0.0,
    "end": 5.3,
    "text": "ะะพะฑััะน ะดะตะฝั!",
    "speaker": "ะััะฝะฐะปะธัั",
    "raw_speaker_id": "SPEAKER_00",
    "confidence": 0.95
}

๐ง ะญะขะะ 4: ะะพััะตะบัะธะธ
ะะพะดัะปะธ: scripts/corrections/

4.1 ะะตัะตะบัะธั ะบะพะผะฐะฝะด ะััะฝะฐะปะธััะฐ
ะคัะฝะบัะธั: detect_journalist_commands_cross_segment()

ะััะฒะปัะตั ัะตะฟะปะธะบะธ-ะบะพะผะฐะฝะดั ะััะฝะฐะปะธััะฐ, ะพัะธะฑะพัะฝะพ ะฟัะธะฟะธัะฐะฝะฝัะต ะญะบัะฟะตััั:

"ะะฐะฒะฐะนัะต ัะฝะธะผะตะผ..."

"ะะพะถะฐะปัะนััะฐ, ัะฐััะบะฐะถะธัะต..."

"ะะพะถะตัะต ะพะฑัััะฝะธัั..."

4.2 Boundary Correction
ะคัะฝะบัะธั: boundary_correction_raw()

ะัะฟัะฐะฒะปัะตั ะณัะฐะฝะธัั ะผะตะถะดั ัะตะณะผะตะฝัะฐะผะธ:

ะัะพะฒะตััะตั ะฟะตัะตะบัััะธั

ะะพััะตะบัะธััะตั ัะฐะนะผะบะพะดั

ะะฐะทะดะตะปัะตั mixed-speaker ัะตะณะผะตะฝัั

4.3 Cross-speaker Deduplication
ะคัะฝะบัะธั: remove_cross_speaker_text_duplicates()

ะฃะดะฐะปัะตั ะดัะฑะปะธะบะฐัั ัะตะบััะฐ ะผะตะถะดั ัะฐะทะฝัะผะธ ัะฟะธะบะตัะฐะผะธ:

# ะัะธะผะตั ะฟัะพะฑะปะตะผั:
ะััะฝะฐะปะธัั: "ะะฐ-ะดะฐ, ะฟะพะฝััะฝะพ, ะดะฐ"
ะญะบัะฟะตัั: "ะะฐ, ะฟะพะฝััะฝะพ"  โ ะดัะฑะปะธะบะฐั, ัะดะฐะปัะตััั

4.4 ะะตะดัะฟะปะธะบะฐัะธั ัะตะณะผะตะฝัะพะฒ
ะคัะฝะบัะธั: deduplicate_segments()

ะฃะดะฐะปัะตั ะฟะพะปะฝะพัััั ะธะดะตะฝัะธัะฝัะต ัะตะณะผะตะฝัั ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ.

๐ ะญะขะะ 5: ะะฑัะฐะฑะพัะบะฐ ะฟะฐัะท (GAP)
ะะพะดัะปั: scripts/core/transcription.py
ะคัะฝะบัะธะธ: gap_detector(), force_transcribe_diar_gaps()

ะะฟะธัะฐะฝะธะต
ะะฑะฝะฐััะถะธะฒะฐะตั ะธ ะทะฐะฟะพะปะฝัะตั ะฟัะพะฟััะบะธ ะฒ ััะฐะฝัะบัะธะฟัะธะธ (gaps).

GAP Detection

# ะัะตะผ ะฟะฐัะทั ะผะตะถะดั ัะตะณะผะตะฝัะฐะผะธ >3s
gap_threshold = 3.0  # seconds

if segment[i+1]["start"] - segment[i]["end"] > gap_threshold:
    # GAP ะพะฑะฝะฐััะถะตะฝ!
    gaps.append({
        "start": segment[i]["end"],
        "end": segment[i+1]["start"],
        "duration": gap_duration
    })

Force Transcribe (v16.5)
ะะทะฒะปะตะบะฐะตั ะฐัะดะธะพ ััะฐะณะผะตะฝั ะธะท GAP

ะัะธะผะตะฝัะตั Whisper ั ะฟะพะฝะธะถะตะฝะฝัะผ no_speech_threshold (0.2)

ะฃะผะฝะฐั ะฐััะธะฑััะธั ะฟะพ ัะตะผะฐะฝัะธัะตัะบะพะผั ััะพะดััะฒั:

similarity_prev = text_similarity(gap_text, prev_segment_text)
similarity_next = text_similarity(gap_text, next_segment_text)

if similarity_prev > similarity_next:
    speaker = prev_segment_speaker
else:
    speaker = next_segment_speaker

ะะพะฑะฐะฒะปัะตั ัะตะณะผะตะฝั ั ะผะตัะบะพะน "source": "GAP_FILLED"

ะะฐัะธัะฐ ะพั ะทะฐะฟะธะฝะพะบ (v16.5)

# ะะต ะฐััะธะฑััะธััะตะผ ะฟัะตะดัะดััะตะผั ัะฟะธะบะตัั ะตัะปะธ:
- ะขะตะบัั ะบะพัะพัะบะธะน (<10 ัะธะผะฒะพะปะพะฒ)
- ะขะตะบัั ัะพะดะตัะถะธั ะฟะพะฒัะพัั ("ั-ั-ั", "ะผ-ะผ-ะผ")
- ะะธะทะบะฐั confidence (<0.6)

๐ ะญะขะะ 6: ะกะปะธัะฝะธะต ัะตะฟะปะธะบ
ะะพะดัะปั: scripts/merge/replica_merger.py
ะคัะฝะบัะธั: merge_replicas()

ะะฟะธัะฐะฝะธะต
ะะฑัะตะดะธะฝัะตั ะบะพัะพัะบะธะต ัะพัะตะดะฝะธะต ัะตะฟะปะธะบะธ ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ ะฒ ะฑะพะปะตะต ะดะปะธะฝะฝัะต.

ะฃัะปะพะฒะธั ัะปะธัะฝะธั

# ะกะปะธะฒะฐะตะผ ะตัะปะธ:
1. ะะดะธะฝ ะธ ัะพั ะถะต ัะฟะธะบะตั
2. ะะฐัะทะฐ ะผะตะถะดั ัะตะฟะปะธะบะฐะผะธ <3s
3. raw_speaker_id ัะพะฒะฟะฐะดะฐะตั (v16.0+)
4. ะกัะผะผะฐัะฝะฐั ะดะปะธัะตะปัะฝะพััั <60s (ััะพะฑั ะฝะต ัะพะทะดะฐะฒะฐัั ะพะณัะพะผะฝัะต ะฑะปะพะบะธ)

ะัะธะผะตั
ะะพ:
[00:00:00] ะััะฝะฐะปะธัั: "ะะพะฑััะน ะดะตะฝั!"
[00:00:02] ะััะฝะฐะปะธัั: "ะะฐััะบะฐะถะธัะต ะพ ะฒะพะนะฝะต"

ะะพัะปะต:
[00:00:00] ะััะฝะฐะปะธัั: "ะะพะฑััะน ะดะตะฝั! ะะฐััะบะฐะถะธัะต ะพ ะฒะพะนะฝะต"

๐ฏ ะญะขะะ 7: ะะปะฐััะธัะธะบะฐัะธั ัะฟะธะบะตัะพะฒ (v15)
ะะพะดัะปั: scripts/corrections/speaker_classifier.py
ะคัะฝะบัะธั: apply_speaker_classification_v15()

ะะฟะธัะฐะฝะธะต
ะะตัะพะฒะฐั ัะธััะตะผะฐ ะดะปั ะบะพััะตะบัะธัะพะฒะบะธ ะฐััะธะฑััะธะธ ัะฟะธะบะตัะพะฒ ะฝะฐ ะพัะฝะพะฒะต ะผะฝะพะถะตััะฒะฐ ัะฐะบัะพัะพะฒ.

ะคะฐะบัะพัั ะธ ะฒะตัะฐ

weights = {
    "duration": 0.30,        # ะะปะธัะตะปัะฝะพััั ัะตะฟะปะธะบะธ
    "position": 0.15,        # ะะพะทะธัะธั ะฒ ะธะฝัะตัะฒัั
    "pattern": 0.25,         # ะขะตะบััะพะฒัะต ะฟะฐััะตัะฝั
    "context": 0.20,         # ะะพะฝัะตะบัั ัะพัะตะดะฝะธั ัะตะฟะปะธะบ
    "diarization": 0.10      # ะัะธะณะธะฝะฐะปัะฝะฐั ะดะธะฐัะธะทะฐัะธั
}

ะะพะณะธะบะฐ
Duration score:

ะะพัะพัะบะธะต (<5s) โ ัะบะพัะตะต ะััะฝะฐะปะธัั

ะะปะธะฝะฝัะต (>30s) โ ัะบะพัะตะต ะญะบัะฟะตัั

Position score:

ะะตัะฒัะต 5 ะผะธะฝัั โ ะฑะพะปััะต ะััะฝะฐะปะธััะฐ

ะกะตัะตะดะธะฝะฐ โ ะฑะพะปััะต ะญะบัะฟะตััะฐ

ะะพัะปะตะดะฝะธะต 5 ะผะธะฝัั โ ัะผะตัะฐะฝะฝะพะต

Pattern score:

ะะฐัะบะตัั ะััะฝะฐะปะธััะฐ: ะฒะพะฟัะพัั, ะบะพะผะฐะฝะดั, ะฟะพะดัะฒะตัะถะดะตะฝะธั

ะะฐัะบะตัั ะญะบัะฟะตััะฐ: ัะตัะผะธะฝั, ัะฐะทะฒััะฝัััะต ะพัะฒะตัั

Context score:

ะะฝะฐะปะธะท 2 ะฟัะตะดัะดััะธั + 2 ัะปะตะดัััะธั ัะตะฟะปะธะบ

ะกะบะปะพะฝะฝะพััั ะบ ัะตัะตะดะพะฒะฐะฝะธั ัะฟะธะบะตัะพะฒ

Diarization score:

ะัะธะณะธะฝะฐะปัะฝะฐั ะผะตัะบะฐ ะพั Pyannote

ะัะฟะพะปัะทัะตััั ะบะฐะบ baseline

ะัะพะณะพะฒะพะต ัะตัะตะฝะธะต

total_score = sum(factor * weight for factor, weight in scores.items())

if total_score > threshold:
    # ะะตัะตะฝะฐะทะฝะฐัะธัั ัะฟะธะบะตัะฐ
    segment["speaker"] = new_speaker
    segment["classification_confidence"] = total_score

โ๏ธ ะญะขะะ 8: ะขะตะบััะพะฒัะต ะธัะฟัะฐะฒะปะตะฝะธั
ะะพะดัะปั: scripts/corrections/text_corrections.py
ะคัะฝะบัะธั: text_based_correction()

8.1 Split Mixed-speaker Segments (v16.4)
ะคัะฝะบัะธั: split_mixed_speaker_segments()

ะะฐะทะดะตะปัะตั ัะตะณะผะตะฝัั, ะณะดะต ะฒะฝัััะธ ัะตะฟะปะธะบะธ ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ ะฒะบัะฐะฟะปะตะฝั ัะปะพะฒะฐ ะดััะณะพะณะพ:

# ะัะธะผะตั:
"ะะฐ, ะฟะพะฝััะฝะพ. [ะััะฝะฐะปะธัั ะฒะผะตัะธะฒะฐะตััั: 'ะฏัะฝะพ'] ะัะพะดะพะปะถั..."
โ
ะกะตะณะผะตะฝั 1: "ะะฐ, ะฟะพะฝััะฝะพ."
ะกะตะณะผะตะฝั 2: "ะฏัะฝะพ" (ะััะฝะฐะปะธัั)
ะกะตะณะผะตะฝั 3: "ะัะพะดะพะปะถั..."

8.2 Text-based Correction (v16.4)
ะะฐัะธัะฐ ะพั ะฟะตัะตะฐััะธะฑััะธะธ ะฝะฐ ะพัะฝะพะฒะต ัะตะบััะพะฒะพะณะพ ัะพะดะตัะถะฐะฝะธั:

Whitelist ััะฐะท ะััะฝะฐะปะธััะฐ:

journalist_patterns = [
    "ะดะฐะฒะฐะนัะต", "ะฟะพะถะฐะปัะนััะฐ", "ัะฐััะบะฐะถะธัะต",
    "ะผะพะถะตัะต ะพะฑัััะฝะธัั", "ััะพ ะฒั ะธะผะตะตัะต ะฒ ะฒะธะดั",
    "ะธะฝัะตัะตัะฝะพ", "ะฟะพะฝััะฝะพ", "ััะฝะพ"
]

Context Window Protection:

# ะะต ััะพะณะฐัั ัะตะณะผะตะฝัั ะฒะฝัััะธ ะดะปะธะฝะฝัั ะผะพะฝะพะปะพะณะพะฒ (>60s)
if is_inside_long_monologue(segment, threshold=60):
    skip_correction = True

Confirmation Pattern Detection:

# ะะตัะตะบัะธั ะบะพัะพัะบะธั ะฟะพะดัะฒะตัะถะดะตะฝะธะน
confirmations = ["ะฝั ะดะฐ", "ะดะฐ-ะดะฐ", "ัะณั", "ะผ-ะผ", "ะฟะพะฝััะฝะพ"]
if text.lower() in confirmations and duration < 2:
    # ะกะบะพัะตะต ะฒัะตะณะพ ะััะฝะฐะปะธัั ะฟะพะดัะฒะตัะถะดะฐะตั

Announcement vs Question:

# ะะฐะทะปะธัะตะฝะธะต ะฐะฝะพะฝัะฐ ะฒะพะฟัะพัะฐ ะธ ะฟะพะปะฝะพะณะพ ะฒะพะฟัะพัะฐ
if text.startswith("ะดะฐะฒะฐะนัะต") and len(text) < 50:
    # ะะฝะพะฝั โ ะััะฝะฐะปะธัั
else:
    # ะะพะปะฝัะน ะฒะพะฟัะพั ั ัะฐะทะฒััะฝัััะผ ะบะพะฝัะตะบััะพะผ โ ะผะพะถะตั ะฑััั ะญะบัะฟะตัั

โ ะญะขะะ 9: ะะฐะปะธะดะฐัะธั ะธ Auto-merge
ะะพะดัะปั: scripts/merge/validator.py

9.1 ะะฐะปะธะดะฐัะธั ัะผะตะถะฝัั ัะตะณะผะตะฝัะพะฒ
ะคัะฝะบัะธั: validate_adjacent_same_speaker()

ะัะพะฒะตััะตั, ะฝะตั ะปะธ ะฟะพะดััะด ะธะดััะธั ัะตะณะผะตะฝัะพะฒ ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ (ะพัะธะฑะบะฐ ะปะพะณะธะบะธ):

errors = []
for i in range(len(segments) - 1):
    if segments[i]["speaker"] == segments[i+1]["speaker"]:
        if segments[i+1]["start"] - segments[i]["end"] < 1.0:
            # ะัะธะฑะบะฐ: ัะผะตะถะฝัะต ัะตะณะผะตะฝัั ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ ั ะฟะฐัะทะพะน <1s
            errors.append((i, i+1))

9.2 Auto-merge (v16.0+)
ะคัะฝะบัะธั: auto_merge_adjacent_same_speaker()

ะะฒัะพะผะฐัะธัะตัะบะธ ัะปะธะฒะฐะตั ัะผะตะถะฝัะต ัะตะณะผะตะฝัั ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ:

ะฃัะปะพะฒะธั ัะปะธัะฝะธั:

if (segment[i]["speaker"] == segment[i+1]["speaker"] and
    segment[i]["raw_speaker_id"] == segment[i+1]["raw_speaker_id"] and
    segment[i+1]["start"] - segment[i]["end"] < 3.0):
    # ะกะปะธัั ัะตะณะผะตะฝัั

โ๏ธ ะะฐะถะฝะพ (v16.0): ะัะพะฒะตัะบะฐ raw_speaker_id ะทะฐัะธัะฐะตั ะพั ัะปะธัะฝะธั ัะตะณะผะตะฝัะพะฒ, ะณะดะต speaker ะฑัะป ะฟะตัะตะฝะฐะทะฝะฐัะตะฝ ะฒัััะฝัั.

9.3 ะะตะฝะตัะฐัะธั ะพััััะฐ
ะคัะฝะบัะธั: generate_validation_report()

ะกะพะทะดะฐัั ัะธะฝะฐะปัะฝัะน ะพัััั:

{
    "total_segments": 241,
    "speakers": {
        "ะััะฝะฐะปะธัั": 152,
        "ะญะบัะฟะตัั": 89
    },
    "total_duration": "01:53:47",
    "errors_found": 0,
    "warnings": [
        "Long pause at 00:15:32 (15s)"
    ]
}

๐ค ะญะขะะ 10: ะญะบัะฟะพัั
ะะพะดัะปะธ: scripts/export/

10.1 JSON Export
ะคัะฝะบัะธั: export_to_json()

ะกะพะทะดะฐัั JSON ัะฐะนะป ั ะฟะพะปะฝะพะน ะธะฝัะพัะผะฐัะธะตะน:

{
    "file_info": {
        "filename": "isaev_part1.wav",
        "duration": 6827.5,
        "speaker_surname": "ะัะฐะตะฒ"
    },
    "segments_raw": [...],
    "segments_merged": [...],
    "speaker_roles": {
        "SPEAKER_00": "ะััะฝะฐะปะธัั",
        "SPEAKER_01": "ะญะบัะฟะตัั"
    },
    "validation_report": {...},
    "corrections_log": {...}
}

10.2 TXT Export
ะคัะฝะบัะธั: export_to_txt(), jsons_to_txt()

ะกะพะทะดะฐัั ัะธัะฐะตะผัะน ัะตะบััะพะฒัะน ัะฐะนะป:

[00:00:00.000] ะััะฝะฐะปะธัั: ะะพะฑััะน ะดะตะฝั!
[00:00:05.300] ะญะบัะฟะตัั: ะะดัะฐะฒััะฒัะนัะต!
[00:00:08.120] ะััะฝะฐะปะธัั: ะะฐััะบะฐะถะธัะต ะพ ะกัะฐะปะธะฝะณัะฐะดัะบะพะน ะฑะธัะฒะต.
[00:00:12.450] ะญะบัะฟะตัั: ะญัะพ ะฑัะปะฐ ะพะดะฝะฐ ะธะท ะบะปััะตะฒัั ะฑะธัะฒ ะัะพัะพะน ะผะธัะพะฒะพะน ะฒะพะนะฝั...

ะคะพัะผะฐั ัะฐะนะผะบะพะดะฐ: [HH:MM:SS.mmm]
ะกะฟะธะบะตั: ะัััะบะพัะทััะฝะพะต ะธะผั ัะพะปะธ
ะขะตะบัั: ะะพะปะฝะฐั ัะตะฟะปะธะบะฐ

๐ ะัะพะผะตะถััะพัะฝัะต ัะพััะฐะฝะตะฝะธั (Debug Mode)
ะัะธ debug=True ะฝะฐ ะบะฐะถะดะพะผ ััะฐะฟะต ัะพััะฐะฝััััั ะฟัะพะผะตะถััะพัะฝัะต JSON:

json/
โโโ isaev_part1.json              # ะคะธะฝะฐะปัะฝัะน ัะตะทัะปััะฐั
โโโ isaev_part1_stage1_raw.json   # ะะพัะปะต ะญะขะะ 3 (ะฒััะฐะฒะฝะธะฒะฐะฝะธะต)
โโโ isaev_part1_stage2_corr.json  # ะะพัะปะต ะญะขะะ 4 (ะบะพััะตะบัะธะธ)
โโโ isaev_part1_stage3_gaps.json  # ะะพัะปะต ะญะขะะ 5 (gaps)
โโโ isaev_part1_stage4_merge.json # ะะพัะปะต ะญะขะะ 6 (ัะปะธัะฝะธะต)
โโโ isaev_part1_stage5_class.json # ะะพัะปะต ะญะขะะ 7 (ะบะปะฐััะธัะธะบะฐัะธั)

ะญัะพ ะฟะพะทะฒะพะปัะตั ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะธะทะผะตะฝะตะฝะธั ะฝะฐ ะบะฐะถะดะพะผ ััะฐะฟะต.

๐ฏ ะัะธัะธัะตัะบะธะต ะฟะฐัะฐะผะตััั
ะะธะฐัะธะทะฐัะธั
min_speakers: 2

max_speakers: 3

ะขัะฐะฝัะบัะธะฑะฐัะธั
model: large-v3-turbo

language: ru

temperature: 0.0

beam_size: 5

no_speech_threshold: 0.2 (ะดะปั gaps)

GAP Detection
gap_threshold: 3.0s

Replica Merger
max_pause: 3.0s

max_duration: 60s

Speaker Classification
confidence_threshold: 0.6

ะะตัะฐ: ัะผ. ะญะขะะ 7

Text Corrections
long_monologue_threshold: 60s

confirmation_max_duration: 2s

๐ ะะตััะธะบะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
ะขะธะฟะธัะฝะพะต ะฒัะตะผั ะพะฑัะฐะฑะพัะบะธ (NVIDIA RTX 3070 8GB):

| ะะปะธัะตะปัะฝะพััั ะฐัะดะธะพ | ะะธะฐัะธะทะฐัะธั | Whisper | Pipeline (ะฟะพะปะฝัะน) |
| ------------------ | ---------- | ------- | ----------------- |
| 10 ะผะธะฝัั           | ~30s       | ~1 ะผะธะฝ  | ~2 ะผะธะฝ            |
| 30 ะผะธะฝัั           | ~1 ะผะธะฝ     | ~3 ะผะธะฝ  | ~5 ะผะธะฝ            |
| 60 ะผะธะฝัั           | ~2 ะผะธะฝ     | ~6 ะผะธะฝ  | ~10 ะผะธะฝ           |
| 120 ะผะธะฝัั          | ~4 ะผะธะฝ     | ~12 ะผะธะฝ | ~20 ะผะธะฝ           |

CPU (ะฑะตะท GPU): ~3-5x ะผะตะดะปะตะฝะฝะตะต

๐ง ะขะพัะบะธ ะพะฟัะธะผะธะทะฐัะธะธ
ะััะพะบะธะน ะฟัะธะพัะธัะตั
Speaker Classification (ะญะขะะ 7) - ัะฐะผัะน ะผะตะดะปะตะฝะฝัะน

GAP Processing (ะญะขะะ 5) - ะผะพะถะตั ะฑััั ะพะฟัะธะผะธะทะธัะพะฒะฐะฝ

Text-based Corrections (ะญะขะะ 8) - ะผะฝะพะณะพ regex ะพะฟะตัะฐัะธะน

ะกัะตะดะฝะธะน ะฟัะธะพัะธัะตั
Boundary Correction (ะญะขะะ 4.2)

Deduplication (ะญะขะะ 4.3, 4.4)

ะะธะทะบะธะน ะฟัะธะพัะธัะตั
Validation (ะญะขะะ 9) - ัะถะต ะฑััััะฐั

Export (ะญะขะะ 10) - I/O bound

ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต: 11.02.2026
ะะตััะธั ะดะพะบัะผะตะฝัะฐ: 1.0
ะะปั ะฒะตััะธะธ ะฟัะพะตะบัะฐ: v16.5


***

## ๐ 4. docs/MODULES.md

```markdown
# ๐ ะกะฟัะฐะฒะพัะฝะธะบ ะผะพะดัะปะตะน ะธ ััะฝะบัะธะน

ะะพะปะฝะพะต ะพะฟะธัะฐะฝะธะต ะฒัะตั ััะฝะบัะธะน ะฟัะพะตะบัะฐ ั ะฟะฐัะฐะผะตััะฐะผะธ ะธ ะฟัะธะผะตัะฐะผะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธั.

---

## ๐ scripts/core/ - ะะฐะทะพะฒะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั

### config.py

**ะะฟะธัะฐะฝะธะต:** ะะพะฝัะธะณััะฐัะธั ะฟัะพะตะบัะฐ ะธ ะบะพะฝััะฐะฝัั

```python
HF_TOKEN: str
    Hugging Face API ัะพะบะตะฝ ะดะปั ะดะพัััะฟะฐ ะบ ะผะพะดะตะปัะผ

VERSION: str
    ะขะตะบััะฐั ะฒะตััะธั ะฟัะพะตะบัะฐ (ะฝะฐะฟัะธะผะตั: "16.5")

VERSION_NAME: str
    ะะพะดะพะฒะพะต ะธะผั ะฒะตััะธะธ (ะฝะฐะฟัะธะผะตั: "Smart GAP Attribution")

utils.py
seconds_to_hms(seconds: float) -> str
ะะพะฝะฒะตััะธััะตั ัะตะบัะฝะดั ะฒ ัะพัะผะฐั HH:MM:SS.mmm

ะะฐัะฐะผะตััั:

seconds: ะัะตะผั ะฒ ัะตะบัะฝะดะฐั

ะะพะทะฒัะฐัะฐะตั: ะกััะพะบะฐ ัะพัะผะฐัะฐ "HH:MM:SS.mmm"

ะัะธะผะตั:

seconds_to_hms(125.456)
# โ "00:02:05.456"

parse_speaker_folder(folder_name: str) -> Tuple[str, str, str]
ะะฐััะธั ะธะผั ะฟะฐะฟะบะธ ัะฟะธะบะตัะฐ

ะะฐัะฐะผะตััั:

folder_name: ะะผั ะฟะฐะฟะบะธ (ัะพัะผะฐั: "ะคะฐะผะธะปะธั (ะะ.ะะ)")

ะะพะทะฒัะฐัะฐะตั: (surname, date, full_name)

ะัะธะผะตั:

parse_speaker_folder("ะัะฐะตะฒ (29.01)")
# โ ("ะัะฐะตะฒ", "29.01", "ะัะฐะตะฒ")

adaptive_vad_threshold(duration: float) -> float
ะััะธัะปัะตั ะฐะดะฐะฟัะธะฒะฝัะน VAD threshold ะฝะฐ ะพัะฝะพะฒะต ะดะปะธัะตะปัะฝะพััะธ

ะะฐัะฐะผะตััั:

duration: ะะปะธัะตะปัะฝะพััั ะฐัะดะธะพ (ัะตะบัะฝะดั)

ะะพะทะฒัะฐัะฐะตั: VAD threshold (0.3-0.5)

ะะพะณะธะบะฐ:

if duration < 600:      # <10 ะผะธะฝ โ 0.3
elif duration < 1800:   # 10-30 ะผะธะฝ โ 0.4
else:                   # >30 ะผะธะฝ โ 0.5

gap_detector(segments: List[Dict], threshold: float = 3.0) -> List[Dict]
ะะฑะฝะฐััะถะธะฒะฐะตั ะฟะฐัะทั (gaps) ะผะตะถะดั ัะตะณะผะตะฝัะฐะผะธ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

threshold: ะะธะฝะธะผะฐะปัะฝะฐั ะดะปะธัะตะปัะฝะพััั ะฟะฐัะทั (default: 3.0s)

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ gaps ั ะฟะพะปัะผะธ:

{
    "gap_hms_start": "00:05:30.000",
    "gap_hms_end": "00:05:35.000",
    "start": 330.0,
    "end": 335.0,
    "duration": 5.0
}

text_similarity(text1: str, text2: str) -> float
๐ v16.5: ะััะธัะปัะตั ัะตะผะฐะฝัะธัะตัะบะพะต ััะพะดััะฒะพ ะดะฒัั ัะตะบััะพะฒ

ะะฐัะฐะผะตััั:

text1, text2: ะขะตะบััั ะดะปั ััะฐะฒะฝะตะฝะธั

ะะพะทะฒัะฐัะฐะตั: ะะพัััะธัะธะตะฝั ััะพะดััะฒะฐ (0.0-1.0)

ะะปะณะพัะธัะผ: Jaccard similarity ะฝะฐ ััะพะฒะฝะต ัะปะพะฒ

ะัะธะผะตั:

text_similarity("ะะพะฑััะน ะดะตะฝั", "ะะพะฑััะน ะฒะตัะตั")
# โ 0.67 (2 ะพะฑัะธั ัะปะพะฒะฐ ะธะท 3)

diarization.py
diarize_audio(pipeline, audio_path: Path, min_speakers: int, max_speakers: int) -> Annotation
ะัะฟะพะปะฝัะตั ะดะธะฐัะธะทะฐัะธั ะฐัะดะธะพ ัะฐะนะปะฐ

ะะฐัะฐะผะตััั:

pipeline: Pyannote pipeline

audio_path: ะััั ะบ WAV ัะฐะนะปั

min_speakers: ะะธะฝะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะฟะธะบะตัะพะฒ (ะพะฑััะฝะพ 2)

max_speakers: ะะฐะบัะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะฟะธะบะตัะพะฒ (ะพะฑััะฝะพ 3)

ะะพะทะฒัะฐัะฐะตั: Pyannote Annotation ะพะฑัะตะบั ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ ัะฟะธะบะตัะพะฒ

ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:

pipeline = Pipeline.from_pretrained("pyannote/speaker-diarization-3.1")
diarization = diarize_audio(pipeline, Path("audio.wav"), 2, 3)

compute_speaker_stats(diarization: Annotation) -> Dict[str, Dict]
ะััะธัะปัะตั ััะฐัะธััะธะบั ะฟะพ ะบะฐะถะดะพะผั ัะฟะธะบะตัั

ะะฐัะฐะผะตััั:

diarization: ะะตะทัะปััะฐั ะดะธะฐัะธะทะฐัะธะธ

ะะพะทะฒัะฐัะฐะตั:

{
    "SPEAKER_00": {
        "total_time": 1234.5,
        "num_segments": 89
    },
    ...
}

identify_speaker_roles(stats: Dict, segments: List[Dict]) -> Dict[str, str]
ะะดะตะฝัะธัะธัะธััะตั ัะพะปะธ ัะฟะธะบะตัะพะฒ (ะััะฝะฐะปะธัั/ะญะบัะฟะตัั/ะะฟะตัะฐัะพั)

ะะฐัะฐะผะตััั:

stats: ะกัะฐัะธััะธะบะฐ ัะฟะธะบะตัะพะฒ

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั:

{
    "SPEAKER_00": "ะััะฝะฐะปะธัั",
    "SPEAKER_01": "ะญะบัะฟะตัั",
    "SPEAKER_02": "ะะฟะตัะฐัะพั"  # ะตัะปะธ ะตััั
}

ะะพะณะธะบะฐ:

ะะธะฝะธะผะฐะปัะฝะพะต ะฒัะตะผั โ ะััะฝะฐะปะธัั

ะะฐะบัะธะผะฐะปัะฝะพะต ะฒัะตะผั โ ะญะบัะฟะตัั

ะะพะฟะพะปะฝะธัะตะปัะฝัะน โ ะะฟะตัะฐัะพั

align_segment_to_diarization(segment: Dict, diarization: Annotation) -> str
ะะฟัะตะดะตะปัะตั ัะฟะธะบะตัะฐ ะดะปั ะพะดะฝะพะณะพ ัะตะณะผะตะฝัะฐ

ะะฐัะฐะผะตััั:

segment: ะกะตะณะผะตะฝั ั ะฟะพะปัะผะธ start, end

diarization: ะะตะทัะปััะฐั ะดะธะฐัะธะทะฐัะธะธ

ะะพะทะฒัะฐัะฐะตั: ID ัะฟะธะบะตัะฐ ("SPEAKER_00", "SPEAKER_01", ...)

alignment.py
align_whisper_with_diarization(segments: List[Dict], diarization: Annotation, speaker_surname: str, speaker_roles: Dict) -> List[Dict]
ะกะฒัะทัะฒะฐะตั ััะฐะฝัะบัะธะฟัะธั Whisper ั ะดะธะฐัะธะทะฐัะธะตะน

ะะฐัะฐะผะตััั:

segments: ะกะตะณะผะตะฝัั ะพั Whisper

diarization: ะะตะทัะปััะฐั ะดะธะฐัะธะทะฐัะธะธ

speaker_surname: ะคะฐะผะธะปะธั ะพัะฝะพะฒะฝะพะณะพ ัะฟะธะบะตัะฐ

speaker_roles: ะะพะปะธ ัะฟะธะบะตัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ ั ะดะพะฑะฐะฒะปะตะฝะฝัะผะธ ะฟะพะปัะผะธ:

{
    "start": 0.0,
    "end": 5.3,
    "text": "ะะพะฑััะน ะดะตะฝั!",
    "speaker": "ะััะฝะฐะปะธัั",
    "raw_speaker_id": "SPEAKER_00",
    "confidence": 0.95
}

transcription.py
transcribe_audio(model, audio_path: Path, language: str, temperature: float, beam_size: int, vad_threshold: float) -> Dict
ะขัะฐะฝัะบัะธะฑะธััะตั ะฐัะดะธะพ ั ะฟะพะผะพััั Whisper

ะะฐัะฐะผะตััั:

model: ะะฐะณััะถะตะฝะฝะฐั ะผะพะดะตะปั Whisper

audio_path: ะััั ะบ WAV ัะฐะนะปั

language: ะะพะด ัะทัะบะฐ ("ru")

temperature: 0.0 ะดะปั ะดะตัะตัะผะธะฝะธะทะผะฐ

beam_size: 5 ะดะปั ะบะฐัะตััะฒะฐ

vad_threshold: ะะพัะพะณ VAD (0.3-0.5)

ะะพะทะฒัะฐัะฐะตั:

{
    "text": "ะฟะพะปะฝัะน ัะตะบัั",
    "segments": [
        {
            "start": 0.0,
            "end": 5.3,
            "text": "ะะพะฑััะน ะดะตะฝั!",
            "confidence": 0.95
        },
        ...
    ]
}

force_transcribe_diar_gaps(model, audio_path: Path, gaps: List[Dict], segments: List[Dict], speaker_surname: str) -> List[Dict]
๐ v16.5: ะะฐะฟะพะปะฝัะตั ะฟัะพะฟััะบะธ (gaps) ั ัะผะฝะพะน ะฐััะธะฑััะธะตะน

ะะฐัะฐะผะตััั:

model: ะะพะดะตะปั Whisper

audio_path: ะััั ะบ ะฐัะดะธะพ

gaps: ะกะฟะธัะพะบ ะพะฑะฝะฐััะถะตะฝะฝัั gaps

segments: ะกััะตััะฒัััะธะต ัะตะณะผะตะฝัั (ะดะปั ะบะพะฝัะตะบััะฐ)

speaker_surname: ะคะฐะผะธะปะธั ัะฟะธะบะตัะฐ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ะฝะพะฒัั ัะตะณะผะตะฝัะพะฒ ะธะท gaps

ะะพะฒะพะต ะฒ v16.5:

ะฃะผะฝะฐั ะฐััะธะฑััะธั ะฟะพ ัะตะผะฐะฝัะธัะตัะบะพะผั ััะพะดััะฒั

ะะฐัะธัะฐ ะพั ะฐััะธะฑััะธะธ ะทะฐะฟะธะฝะพะบ ะฟัะตะดัะดััะตะผั ัะฟะธะบะตัั

ะัะฟะพะปัะทะพะฒะฐะฝะธะต text_similarity() ะดะปั ะฐะฝะฐะปะธะทะฐ

ะะปะณะพัะธัะผ:

gap_text = transcribe_gap_audio()

# ะกัะฐะฒะฝะธะฒะฐะตะผ ั ัะพัะตะดะฝะธะผะธ ัะตะณะผะตะฝัะฐะผะธ
similarity_prev = text_similarity(gap_text, prev_segment["text"])
similarity_next = text_similarity(gap_text, next_segment["text"])

if similarity_prev > similarity_next:
    speaker = prev_segment["speaker"]
else:
    speaker = next_segment["speaker"]

# ะะฐัะธัะฐ ะพั ะทะฐะฟะธะฝะพะบ
if len(gap_text) < 10 or confidence < 0.6:
    # ะัะฟะพะปัะทัะตะผ ะดะธะฐัะธะทะฐัะธั ะฒะผะตััะพ ัะตะผะฐะฝัะธะบะธ
    speaker = diarization_speaker

๐ scripts/corrections/ - ะะพััะตะบัะธั ัะตะทัะปััะฐัะพะฒ
hallucinations.py
filter_hallucination_segments(segments: List[Dict]) -> List[Dict]
ะคะธะปััััะตั ะณะฐะปะปััะธะฝะฐัะธะธ Whisper

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะััะธะปัััะพะฒะฐะฝะฝัะน ัะฟะธัะพะบ

ะัะธัะตัะธะธ ะณะฐะปะปััะธะฝะฐัะธะธ:

ะะพะฒัะพััััะธะนัั ัะตะบัั (>3 ัะฐะทะฐ)

ะะธะทะบะฐั confidence (<0.4)

ะะพะดะพะทัะธัะตะปัะฝัะต ะฟะฐััะตัะฝั

clean_hallucinations_from_text(text: str) -> str
ะัะธัะฐะตั ัะตะบัั ะพั ะธะทะฒะตััะฝัั ะณะฐะปะปััะธะฝะฐัะธะน

ะะฐัะฐะผะตััั:

text: ะััะพะดะฝัะน ัะตะบัั

ะะพะทะฒัะฐัะฐะตั: ะัะธัะตะฝะฝัะน ัะตะบัั

ะัะธะผะตัั ัะดะฐะปัะตะผะพะณะพ:

"ะกัะฑัะธััั ัะดะตะปะฐะป DimaTorzok"

"ะะพะดะฟะธััะฒะฐะนัะตัั ะฝะฐ ะบะฐะฝะฐะป"

ะะพะฒัะพัั ััะฐะท

speaker_classifier.py
apply_speaker_classification_v15(segments: List[Dict], speaker_surname: str, debug: bool = False) -> Tuple[List[Dict], Dict]
ะะตัะพะฒะฐั ะบะปะฐััะธัะธะบะฐัะธั ัะฟะธะบะตัะพะฒ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

debug: ะัะฒะพะด ะพัะปะฐะดะพัะฝะพะน ะธะฝัะพัะผะฐัะธะธ

ะะพะทะฒัะฐัะฐะตั: (segments_updated, stats)

ะกะธััะตะผะฐ ะฒะตัะพะฒ:

{
    "duration": 0.30,    # ะะปะธัะตะปัะฝะพััั ัะตะฟะปะธะบะธ
    "position": 0.15,    # ะะพะทะธัะธั ะฒ ะธะฝัะตัะฒัั
    "pattern": 0.25,     # ะขะตะบััะพะฒัะต ะฟะฐััะตัะฝั
    "context": 0.20,     # ะะพะฝัะตะบัั ัะพัะตะดะตะน
    "diarization": 0.10  # ะัะธะณะธะฝะฐะปัะฝะฐั ะผะตัะบะฐ
}

ะกัะฐัะธััะธะบะฐ:

{
    "total_corrections": 15,
    "journalist_to_expert": 8,
    "expert_to_journalist": 7,
    "avg_confidence": 0.85
}

boundary_fixer.py
boundary_correction_raw(segments: List[Dict], speaker_surname: str, speaker_roles: Dict) -> List[Dict]
ะะพััะตะบัะธััะตั ะณัะฐะฝะธัั ะผะตะถะดั ัะตะณะผะตะฝัะฐะผะธ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะฟะธะบะตัะฐ

speaker_roles: ะะพะปะธ ัะฟะธะบะตัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ั ะธัะฟัะฐะฒะปะตะฝะฝัะผะธ ะณัะฐะฝะธัะฐะผะธ

ะงัะพ ะธัะฟัะฐะฒะปัะตั:

ะะตัะตะบัััะธั ัะฐะนะผะบะพะดะพะฒ

ะกะปะธัะบะพะผ ะบะพัะพัะบะธะต/ะดะปะธะฝะฝัะต ะฟะฐัะทั

ะะฐะทััะฒั ะฒ ะดะธะฐะปะพะณะต

split_mixed_speaker_segments(segments: List[Dict], speaker_surname: str) -> List[Dict]
๐ง v16.4: ะะฐะทะดะตะปัะตั mixed-speaker ัะตะณะผะตะฝัั ั ะฟะตัะตััััะพะผ ัะฐะนะผะบะพะดะพะฒ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ั ัะฐะทะดะตะปัะฝะฝัะผะธ ัะตะณะผะตะฝัะฐะผะธ

ะัะธะผะตั:

# ะะพ:
[{"text": "ะะฐ, ะฟะพะฝััะฝะพ. [ะฒะผะตัะธะฒะฐะตััั] ะัะพะดะพะปะถั", "speaker": "ะญะบัะฟะตัั"}]

# ะะพัะปะต:
[
    {"text": "ะะฐ, ะฟะพะฝััะฝะพ.", "speaker": "ะญะบัะฟะตัั"},
    {"text": "ะฒะผะตัะธะฒะฐะตััั", "speaker": "ะััะฝะฐะปะธัั"},
    {"text": "ะัะพะดะพะปะถั", "speaker": "ะญะบัะฟะตัั"}
]

journalist_commands.py
detect_journalist_commands_cross_segment(segments: List[Dict], speaker_surname: str) -> Tuple[List[Dict], List[Dict]]
ะะตัะตะบัะธััะตั ะบะพะผะฐะฝะดั ะััะฝะฐะปะธััะฐ, ะฟัะธะฟะธัะฐะฝะฝัะต ะญะบัะฟะตััั

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

ะะพะทะฒัะฐัะฐะตั: (corrected_segments, corrections_log)

ะะตัะตะบัะธััะตะผัะต ะฟะฐััะตัะฝั:

[
    "ะดะฐะฒะฐะนัะต", "ะฟะพะถะฐะปัะนััะฐ", "ัะฐััะบะฐะถะธัะต",
    "ะผะพะถะตัะต", "ะพะฑัััะฝะธัะต", "ะฟะพะบะฐะถะธัะต"
]

text_corrections.py
text_based_correction(segments: List[Dict], speaker_surname: str) -> List[Dict]
๐ง v16.4: ะะฐััะธัะตะฝะฝะฐั ัะตะบััะพะฒะฐั ะบะพััะตะบัะธั

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

ะะพะทะฒัะฐัะฐะตั: ะัะฟัะฐะฒะปะตะฝะฝัะน ัะฟะธัะพะบ

ะะพะฒะพะต ะฒ v16.4:

Context window protection (ะผะพะฝะพะปะพะณะธ >60s)

Confirmation pattern detection

Announcement vs Question distinction

ะัะธะผะตัั ะทะฐัะธัั:

# Context Window Protection
if in_long_monologue(segment, threshold=60):
    skip_correction()  # ะะต ััะพะณะฐัั ัะตัะตะดะธะฝั ะผะพะฝะพะปะพะณะฐ

# Confirmation Detection
if text in ["ะฝั ะดะฐ", "ะดะฐ-ะดะฐ", "ัะณั"] and duration < 2:
    force_journalist()

# Announcement vs Question
if text.startswith("ะดะฐะฒะฐะนัะต") and len(text) < 50:
    force_journalist()  # ะะพัะพัะบะธะน ะฐะฝะพะฝั

๐ scripts/merge/ - ะกะปะธัะฝะธะต ะธ ะฒะฐะปะธะดะฐัะธั
replica_merger.py
merge_replicas(segments: List[Dict]) -> List[Dict]
ะะฑัะตะดะธะฝัะตั ะบะพัะพัะบะธะต ัะตะฟะปะธะบะธ ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ั ะพะฑัะตะดะธะฝัะฝะฝัะผะธ ัะตะฟะปะธะบะฐะผะธ

ะฃัะปะพะฒะธั ัะปะธัะฝะธั:

same_speaker and
pause < 3.0 and
same_raw_speaker_id and  # v16.0+
total_duration < 60

deduplicator.py
remove_cross_speaker_text_duplicates(segments: List[Dict]) -> List[Dict]
ะฃะดะฐะปัะตั ะดัะฑะปะธะบะฐัั ัะตะบััะฐ ะผะตะถะดั ัะฐะทะฝัะผะธ ัะฟะธะบะตัะฐะผะธ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ะฑะตะท ะดัะฑะปะธะบะฐัะพะฒ

ะัะธะผะตั:

# ะะพ:
ะััะฝะฐะปะธัั: "ะะฐ-ะดะฐ, ะฟะพะฝััะฝะพ, ะดะฐ"
ะญะบัะฟะตัั: "ะะฐ, ะฟะพะฝััะฝะพ"  โ ะดัะฑะปะธะบะฐั

# ะะพัะปะต:
ะััะฝะฐะปะธัั: "ะะฐ-ะดะฐ, ะฟะพะฝััะฝะพ, ะดะฐ"
ะญะบัะฟะตัั: ""  โ ัะดะฐะปัะฝ

deduplicate_segments(segments: List[Dict]) -> List[Dict]
ะฃะดะฐะปัะตั ะฟะพะปะฝะพัััั ะธะดะตะฝัะธัะฝัะต ัะตะณะผะตะฝัั

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ะฑะตะท ะดัะฑะปะธะบะฐัะพะฒ

validator.py
validate_adjacent_same_speaker(segments: List[Dict]) -> List[Tuple[int, int]]
ะัะพะฒะตััะตั ัะผะตะถะฝัะต ัะตะณะผะตะฝัั ะพะดะฝะพะณะพ ัะฟะธะบะตัะฐ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ะฟะฐั ะธะฝะดะตะบัะพะฒ ั ะพัะธะฑะบะฐะผะธ

ะัะธะผะตั:

errors = validate_adjacent_same_speaker(segments)
# โ [(5, 6), (12, 13)]  # ะกะตะณะผะตะฝัั 5-6 ะธ 12-13 ะดะพะปะถะฝั ะฑััั ัะปะธัั

auto_merge_adjacent_same_speaker(segments: List[Dict]) -> List[Dict]
๐ง v16.0: ะะฒัะพะผะฐัะธัะตัะบะธ ัะปะธะฒะฐะตั ัะผะตะถะฝัะต ัะตะณะผะตะฝัั ั ะฟัะพะฒะตัะบะพะน raw_speaker_id

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะะพะทะฒัะฐัะฐะตั: ะกะฟะธัะพะบ ัะพ ัะปะธััะผะธ ัะตะณะผะตะฝัะฐะผะธ

ะะพะฒะพะต ะฒ v16.0:

# ะัะพะฒะตััะตะผ raw_speaker_id ะฟะตัะตะด ัะปะธัะฝะธะตะผ
if (same_speaker and
    same_raw_speaker_id and  # โ ะทะฐัะธัะฐ ะพั ะฝะตะฒะตัะฝะพะณะพ ัะปะธัะฝะธั
    pause < 3.0):
    merge()

generate_validation_report(segments: List[Dict], speaker_surname: str) -> Dict
ะะตะฝะตัะธััะตั ัะธะฝะฐะปัะฝัะน ะพัััั ะฒะฐะปะธะดะฐัะธะธ

ะะฐัะฐะผะตััั:

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

ะะพะทะฒัะฐัะฐะตั:

{
    "total_segments": 241,
    "speakers": {
        "ะััะฝะฐะปะธัั": 152,
        "ะญะบัะฟะตัั": 89
    },
    "total_duration": "01:53:47",
    "avg_segment_duration": {
        "ะััะฝะฐะปะธัั": 5.2,
        "ะญะบัะฟะตัั": 18.7
    },
    "errors_found": 0,
    "warnings": [
        "Long pause at 00:15:32 (15s)"
    ]
}

๐ scripts/export/ - ะญะบัะฟะพัั ะดะฐะฝะฝัั
json_export.py
export_to_json(json_path: Path, segments_raw: List, segments_merged: List, file_info: Dict, speaker_roles: Dict, validation_report: Dict, corrections_log: Dict)
ะญะบัะฟะพััะธััะตั ะดะฐะฝะฝัะต ะฒ JSON

ะะฐัะฐะผะตััั:

json_path: ะััั ะดะปั ัะพััะฐะฝะตะฝะธั

segments_raw: ะกะตะณะผะตะฝัั ะฟะพัะปะต ะฒััะฐะฒะฝะธะฒะฐะฝะธั

segments_merged: ะคะธะฝะฐะปัะฝัะต ัะตะณะผะตะฝัั

file_info: ะะฝัะพัะผะฐัะธั ะพ ัะฐะนะปะต

speaker_roles: ะะพะปะธ ัะฟะธะบะตัะพะฒ

validation_report: ะัััั ะฒะฐะปะธะดะฐัะธะธ

corrections_log: ะะพะณ ะบะพััะตะบัะธะน

ะกะพะทะดะฐัั: JSON ัะฐะนะป ั ะฟะพะปะฝะพะน ะธะฝัะพัะผะฐัะธะตะน

txt_export.py
export_to_txt(txt_path: Path, segments: List[Dict])
ะญะบัะฟะพััะธััะตั ัะตะณะผะตะฝัั ะฒ TXT

ะะฐัะฐะผะตััั:

txt_path: ะััั ะดะปั ัะพััะฐะฝะตะฝะธั

segments: ะกะฟะธัะพะบ ัะตะณะผะตะฝัะพะฒ

ะกะพะทะดะฐัั: TXT ัะฐะนะป ะฒ ัะพัะผะฐัะต:

[HH:MM:SS.mmm] ะกะฟะธะบะตั: ะขะตะบัั

jsons_to_txt(json_files: List[Path], txt_path: Path, speaker_surname: str)
ะะฑัะตะดะธะฝัะตั ะฝะตัะบะพะปัะบะพ JSON ะฒ ะพะดะธะฝ TXT

ะะฐัะฐะผะตััั:

json_files: ะกะฟะธัะพะบ ะฟััะตะน ะบ JSON

txt_path: ะััั ะดะปั TXT

speaker_surname: ะคะฐะผะธะปะธั ัะบัะฟะตััะฐ

ะกะพะทะดะฐัั: ะะฑัะตะดะธะฝัะฝะฝัะน TXT ัะพ ะฒัะตะผะธ ัะตะฟะปะธะบะฐะผะธ ะธะท ะฒัะตั ัะฐะนะปะพะฒ